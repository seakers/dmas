
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iridium_engineering &#8212; 3D-CHESS 0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for iridium_engineering</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">asyncio</span> <span class="kn">import</span> <span class="n">CancelledError</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">messages</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">modules</span> <span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span> <span class="nn">engineering</span> <span class="kn">import</span> <span class="o">*</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">--------------------------------------------------------</span>
<span class="sd"> ________  ___  ___  ________  ________       ___    ___ ________  _________  _______   _____ ______      </span>
<span class="sd">|\   ____\|\  \|\  \|\   __  \|\   ____\     |\  \  /  /|\   ____\|\___   ___\\  ___ \ |\   _ \  _   \    </span>
<span class="sd">\ \  \___|\ \  \\\  \ \  \|\ /\ \  \___|_    \ \  \/  / | \  \___|\|___ \  \_\ \   __/|\ \  \\\__\ \  \   </span>
<span class="sd"> \ \_____  \ \  \\\  \ \   __  \ \_____  \    \ \    / / \ \_____  \   \ \  \ \ \  \_|/_\ \  \\|__| \  \  </span>
<span class="sd">  \|____|\  \ \  \\\  \ \  \|\  \|____|\  \    \/  /  /   \|____|\  \   \ \  \ \ \  \_|\ \ \  \    \ \  \ </span>
<span class="sd">    ____\_\  \ \_______\ \_______\____\_\  \ __/  / /       ____\_\  \   \ \__\ \ \_______\ \__\    \ \__\</span>
<span class="sd">   |\_________\|_______|\|_______|\_________\\___/ /       |\_________\   \|__|  \|_______|\|__|     \|__|</span>
<span class="sd">   \|_________|                  \|_________\|___|/        \|_________|                                   </span>

<span class="sd"> _____ ______   ________  ________  ___  ___  ___       _______   ________      </span>
<span class="sd">|\   _ \  _   \|\   __  \|\   ___ \|\  \|\  \|\  \     |\  ___ \ |\   ____\     </span>
<span class="sd">\ \  \\\__\ \  \ \  \|\  \ \  \_|\ \ \  \\\  \ \  \    \ \   __/|\ \  \___|_    </span>
<span class="sd"> \ \  \\|__| \  \ \  \\\  \ \  \ \\ \ \  \\\  \ \  \    \ \  \_|/_\ \_____  \   </span>
<span class="sd">  \ \  \    \ \  \ \  \\\  \ \  \_\\ \ \  \\\  \ \  \____\ \  \_|\ \|____|\  \  </span>
<span class="sd">   \ \__\    \ \__\ \_______\ \_______\ \_______\ \_______\ \_______\____\_\  \ </span>
<span class="sd">    \|__|     \|__|\|_______|\|_______|\|_______|\|_______|\|_______|\_________\</span>
<span class="sd">                                                                    \|_________|</span>
<span class="sd">--------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">COMMS</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="IridiumCommsSubsystem"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumCommsSubsystem">[docs]</a><span class="k">class</span> <span class="nc">IridiumCommsSubsystem</span><span class="p">(</span><span class="n">SubsystemModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">parent_platform_sim</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> 
                <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span>
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Represents the communications subsystem in an agent. Can receive and transmit messages between agents.</span>
<span class="sd">        parent_platform_sim:</span>
<span class="sd">            platform simulation that the subsystem exists in</span>
<span class="sd">        buffer_size:</span>
<span class="sd">            size of the buffer in bytes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">SubsystemNames</span><span class="o">.</span><span class="n">COMMS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_platform_sim</span><span class="p">,</span> <span class="n">IridiumCommsSubsystemState</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">IridiumTransmitterComponent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">),</span>
                            <span class="n">IridiumReceiverComponent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">)</span>
                            <span class="p">]</span></div>

<div class="viewcode-block" id="IridiumCommsSubsystemState"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumCommsSubsystemState">[docs]</a><span class="k">class</span> <span class="nc">IridiumCommsSubsystemState</span><span class="p">(</span><span class="n">SubsystemState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_states</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">health</span><span class="p">:</span> <span class="n">SubsystemHealth</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">SubsystemStatus</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">SubsystemNames</span><span class="o">.</span><span class="n">COMMS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">IridiumCommsSubsystem</span><span class="p">,</span> <span class="n">component_states</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>

<div class="viewcode-block" id="IridiumCommsSubsystemState.from_subsystem"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumCommsSubsystemState.from_subsystem">[docs]</a>    <span class="k">def</span> <span class="nf">from_subsystem</span><span class="p">(</span><span class="n">comms</span> <span class="p">:</span> <span class="n">IridiumCommsSubsystem</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">IridiumCommsSubsystemState</span><span class="p">(</span><span class="n">comms</span><span class="o">.</span><span class="n">component_states</span><span class="p">,</span> <span class="n">comms</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">comms</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="IridiumTransmitterComponent"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumTransmitterComponent">[docs]</a><span class="k">class</span> <span class="nc">IridiumTransmitterComponent</span><span class="p">(</span><span class="n">ComponentModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">parent_subsystem</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> 
                <span class="n">average_power_consumption</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">buffer_capacity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">OFF</span><span class="p">,</span> 
                <span class="n">f_update</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describes a receiver transmitter capable of sending messages to other agents</span>

<span class="sd">        parent_subsystem:</span>
<span class="sd">            parent comms subsystem</span>
<span class="sd">        average_power_consumption:</span>
<span class="sd">            average power consumption in [W]</span>
<span class="sd">        buffer_capacity:</span>
<span class="sd">            size of the buffer in [Mbytes]</span>
<span class="sd">        health:</span>
<span class="sd">            health of the component</span>
<span class="sd">        status:</span>
<span class="sd">            status of the component</span>
<span class="sd">        f_update:</span>
<span class="sd">            frequency of periodic state checks in [Hz]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">TRANSMITTER</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_subsystem</span><span class="p">,</span> <span class="n">IridiumTransmitterState</span><span class="p">,</span> <span class="n">average_power_consumption</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">f_update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">=</span> <span class="n">buffer_capacity</span> <span class="o">*</span> <span class="mf">1e6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="IridiumTransmitterComponent.activate"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumTransmitterComponent.activate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="IridiumTransmitterComponent.internal_message_handler"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumTransmitterComponent.internal_message_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">internal_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InternalMessage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes messages being sent to this component. Only accepts task messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="c1"># this module is NOT the intended receiver for this message. Forwarding to rightful destination</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received internal message intended for </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span><span class="si">}</span><span class="s1">. Rerouting message...&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ComponentTaskMessage</span><span class="p">):</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_task</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received a task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ComponentAbortTask</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">aborts</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ComponentMaintenanceTask</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">maintenance_tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">TransmitMessageTask</span><span class="p">):</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

                    <span class="n">t_msg</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">msg</span>
                    <span class="n">t_msg_str</span> <span class="o">=</span> <span class="n">t_msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
                    <span class="n">t_msg_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_msg_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">+</span> <span class="n">t_msg_length</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Acepted out-going transmission into buffer!&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">+=</span> <span class="n">t_msg_length</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Out-going message of length </span><span class="si">{</span><span class="n">t_msg_length</span><span class="si">}</span><span class="s1"> now stored in out-going buffer (current state: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rejected out-going transmission into buffer.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Out-going buffer cannot store out-going message of length </span><span class="si">{</span><span class="n">t_msg_length</span><span class="si">}</span><span class="s1"> (current state: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="si">}</span><span class="s1">). Discarding message...&#39;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>                   
            
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">EnvironmentBroadcastMessage</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received an environment event of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environment_events</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">InterNodeDownlinkMessage</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Transmitting an internode downlink message!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                <span class="n">agent_port_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span><span class="o">.</span><span class="n">AGENT_TO_PORT_MAP</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">dst</span> <span class="o">=</span> <span class="s2">&quot;Central Node&quot;</span>
                <span class="n">task_msg</span> <span class="o">=</span> <span class="n">TransmitMessageTask</span><span class="p">(</span><span class="n">agent_port_dict</span><span class="p">[</span><span class="s2">&quot;Central Node&quot;</span><span class="p">],</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task_msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">InterNodeMessage</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received an internode message!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                <span class="n">agent_port_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span><span class="o">.</span><span class="n">AGENT_TO_PORT_MAP</span>
                <span class="k">for</span> <span class="n">agent_port</span> <span class="ow">in</span> <span class="n">agent_port_dict</span><span class="p">:</span>
                    <span class="n">agent</span> <span class="o">=</span> <span class="n">agent_port_dict</span><span class="p">[</span><span class="n">agent_port</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sending to agent: </span><span class="si">{</span><span class="n">agent_port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">agent_port</span> <span class="o">==</span> <span class="s2">&quot;Iridium&quot;</span> <span class="ow">or</span> <span class="n">agent_port</span> <span class="o">==</span> <span class="n">msg</span><span class="o">.</span><span class="n">src_module</span> <span class="ow">or</span> <span class="n">agent_port</span> <span class="o">==</span> <span class="s2">&quot;Central Node&quot;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">inter_node_msg</span> <span class="o">=</span> <span class="n">InterNodeMeasurementRequestMessage</span><span class="p">(</span><span class="s2">&quot;Iridium&quot;</span><span class="p">,</span><span class="n">agent_port</span><span class="p">,</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                    <span class="n">task_msg</span> <span class="o">=</span> <span class="n">TransmitMessageTask</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span><span class="n">inter_node_msg</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task_msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">MeasurementRequest</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received an measurement request!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                <span class="n">agent_port_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span><span class="o">.</span><span class="n">AGENT_TO_PORT_MAP</span>
                <span class="k">for</span> <span class="n">agent_port</span> <span class="ow">in</span> <span class="n">agent_port_dict</span><span class="p">:</span>
                    <span class="n">agent</span> <span class="o">=</span> <span class="n">agent_port_dict</span><span class="p">[</span><span class="n">agent_port</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sending to agent: </span><span class="si">{</span><span class="n">agent_port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">agent_port</span> <span class="o">==</span> <span class="s2">&quot;Iridium&quot;</span> <span class="ow">or</span> <span class="n">agent_port</span> <span class="o">==</span> <span class="n">msg</span><span class="o">.</span><span class="n">src_module</span> <span class="ow">or</span> <span class="n">agent_port</span> <span class="o">==</span> <span class="s2">&quot;Central Node&quot;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">task_msg</span> <span class="o">=</span> <span class="n">TransmitMessageTask</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Internal message of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported. Discarding message...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span>  </div>

<div class="viewcode-block" id="IridiumTransmitterComponent.is_critical"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumTransmitterComponent.is_critical">[docs]</a>    <span class="k">def</span> <span class="nf">is_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_critical</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">-</span><span class="n">threshold</span> </div>

<div class="viewcode-block" id="IridiumTransmitterComponent.is_failed"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumTransmitterComponent.is_failed">[docs]</a>    <span class="k">def</span> <span class="nf">is_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_failed</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">&gt;=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="IridiumTransmitterComponent.perform_task"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumTransmitterComponent.perform_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">perform_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">ComponentTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskStatus</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a task given to this component. </span>
<span class="sd">        Rejects any tasks if the component is in a failure mode of if it is not intended for to be performed by this component. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># check if component was the intended performer of this task</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">component</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component task not intended for this component. Initially intended for component </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">. Aborting task...&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">TransmitMessageTask</span><span class="p">):</span>
                <span class="c1"># create task variables</span>
                <span class="n">wait_for_access_start</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">transmit_msg</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">wait_for_access_end</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">wait_for_access_end_event</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">wait_for_message_timeout</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># unpackage message</span>
                <span class="n">msg</span> <span class="p">:</span> <span class="n">InterNodeMessage</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">msg</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Right before wait_for_access_start in perform_task&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                <span class="c1"># wait for access to target node</span>
                <span class="c1">#wait_for_access_start = asyncio.create_task( self.wait_for_access_start(msg.dst) )</span>
                <span class="c1">#await wait_for_access_start</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Right before create_tasks in perform_task&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                <span class="c1"># wait for msg to be transmitted successfully or interrupted due to access end or message timeout</span>
                <span class="n">transmit_msg</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">transmit_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">)</span>
                <span class="c1">#wait_for_access_end = asyncio.create_task( self.wait_for_access_end(msg.dst) )</span>
                <span class="c1">#wait_for_access_end_event = asyncio.create_task( self.access_events[msg.dst].wait_end() ) </span>
                <span class="c1">#wait_for_message_timeout = asyncio.create_task( self.sim_wait(100.0) )</span>
                <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span><span class="n">transmit_msg</span><span class="p">]</span> <span class="c1"># TODO add waits back: wait_for_access_start, wait_for_access_end, wait_for_access_end_event, wait_for_message_timeout</span>

                <span class="n">_</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                
                <span class="c1"># cancel all pending processes</span>
                <span class="k">for</span> <span class="n">pending_task</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cancelling pending processes!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                    <span class="n">pending_task</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span>
                    <span class="n">pending_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cancelled pending processes!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

                <span class="c1"># remove message from out-going buffer</span>
                <span class="c1"># await self.remove_msg_from_buffer(msg)</span>
                <span class="c1"># self.access_events.pop(msg.dst)</span>

                <span class="c1"># return task completion status                </span>
                <span class="k">if</span> <span class="n">transmit_msg</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Successfully transmitted message of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1"> to target </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>                    
                    <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">DONE</span>

                <span class="c1"># elif (wait_for_access_end.done() and wait_for_access_end not in pending) or (wait_for_access_end_event.done() and wait_for_access_end_event not in pending):</span>
                <span class="c1">#     self.log(f&#39;Access to target \&#39;{msg.dst}\&#39; lost during transmission of message of type {type(msg)}!&#39;,level=logging.DEBUG)</span>
                <span class="c1">#     raise asyncio.CancelledError</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Message of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1"> timed out!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported.&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span> 
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Aborting task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

            <span class="c1"># release update lock if cancelled during task handling</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="c1"># cancel any task that&#39;s not yet completed</span>
            <span class="c1"># if not wait_for_access_start.done():</span>
            <span class="c1">#     wait_for_access_start.cancel()</span>
            <span class="c1">#     await wait_for_access_start</span>

            <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                    <span class="k">await</span> <span class="n">process</span>

            <span class="c1"># return task abort status</span>
            <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">ABORTED</span></div>

<div class="viewcode-block" id="IridiumTransmitterComponent.transmit_message"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumTransmitterComponent.transmit_message">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">transmit_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InterNodeMessage</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;In transmit_message&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="c1"># reformat message</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">msg_json</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
            <span class="n">parent_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span>
            <span class="c1"># connect socket to destination </span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">parent_agent</span><span class="o">.</span><span class="n">AGENT_TO_PORT_MAP</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connecting to agent </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="s1"> through port number </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_out</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connected to agent </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

            <span class="c1"># submit request</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Transmitting a message of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1"> (from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="s1">)...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_out_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Acquired lock.&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_out</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">msg_json</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1"> message sent successfully. Awaiting response...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                        
            <span class="c1"># wait for server reply</span>
            <span class="k">await</span> <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_out</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
            <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_out_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received message reception confirmation!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>      

            <span class="c1"># disconnect socket from destination</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Disconnecting from agent </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_out</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Disconnected from agent </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;asyncio CancelledError in transmit_message&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_out_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Released agent_socket_out lock.&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="k">return</span></div>


    <span class="c1"># async def transmit_message(self, msg: InterNodeMessage):</span>
    <span class="c1">#     # reformat message</span>
    <span class="c1">#     msg.src = self.name</span>
    <span class="c1">#     msg_json = msg.to_json()</span>

    <span class="c1">#     # connect socket to destination </span>
    <span class="c1">#     port = self.AGENT_TO_PORT_MAP[msg.dst]</span>
    <span class="c1">#     self.log(f&#39;Connecting to agent {msg.dst} through port number {port}...&#39;)</span>
    <span class="c1">#     self.agent_socket_out.connect(f&quot;tcp://localhost:{port}&quot;)</span>
    <span class="c1">#     self.log(f&#39;Connected to agent {msg.dst}!&#39;)</span>

    <span class="c1">#     # submit request</span>
    <span class="c1">#     self.log(f&#39;Transmitting a message of type {type(msg)} (from {self.name} to {msg.dst})...&#39;)</span>
    <span class="c1">#     await self.agent_socket_out_lock.acquire()</span>
    <span class="c1">#     await self.agent_socket_out.send_json(msg_json)</span>
    <span class="c1">#     self.log(f&#39;{type(msg)} message sent successfully. Awaiting response...&#39;)</span>
        
    <span class="c1">#     # wait for server reply</span>
    <span class="c1">#     await self.agent_socket_out.recv()</span>
    <span class="c1">#     self.agent_socket_out_lock.release()</span>
    <span class="c1">#     self.log(f&#39;Received message reception confirmation!&#39;)      </span>

    <span class="c1">#     # disconnect socket from destination</span>
    <span class="c1">#     self.log(f&#39;Disconnecting from agent {msg.dst}...&#39;)</span>
    <span class="c1">#     self.agent_socket_out.disconnect(f&quot;tcp://localhost:{port}&quot;)</span>
    <span class="c1">#     self.log(f&#39;Disconnected from agent {msg.dst}!&#39;)</span>

<div class="viewcode-block" id="IridiumTransmitterComponent.remove_msg_from_buffer"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumTransmitterComponent.remove_msg_from_buffer">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">remove_msg_from_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">InterNodeMessage</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Removing message from out-going buffer...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

            <span class="n">msg_str</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
            <span class="n">msg_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">-</span> <span class="n">msg_length</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">-=</span> <span class="n">msg_length</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Message sucessfully removed from buffer!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="IridiumTransmitterComponent.wait_for_access_start"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumTransmitterComponent.wait_for_access_start">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for_access_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;In wait_for_access_start in perform_task&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">AgentAccessSenseMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="n">response</span> <span class="p">:</span> <span class="n">AgentAccessSenseMessage</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_environment_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>            
            <span class="k">while</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_FREQUENCY</span><span class="p">)</span>
                <span class="n">response</span> <span class="p">:</span> <span class="n">AgentAccessSenseMessage</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_environment_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Response </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1"> in perform_task&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">EventPair</span><span class="p">()</span>        

            <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">trigger_start</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="IridiumTransmitterComponent.wait_for_access_end"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumTransmitterComponent.wait_for_access_end">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for_access_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">AgentAccessSenseMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="n">response</span> <span class="p">:</span> <span class="n">AgentAccessSenseMessage</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_environment_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>
            <span class="k">while</span> <span class="n">response</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_FREQUENCY</span><span class="p">)</span>
                <span class="n">response</span> <span class="p">:</span> <span class="n">AgentAccessSenseMessage</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_environment_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">EventPair</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">trigger_end</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="IridiumTransmitterComponent.environment_event_handler"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumTransmitterComponent.environment_event_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">environment_event_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_msg</span> <span class="p">:</span> <span class="n">EnvironmentBroadcastMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Affects the component depending on the type of event being received.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event_msg</span><span class="p">,</span> <span class="n">AgentAccessEventBroadcastMessage</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event_msg</span><span class="o">.</span><span class="n">rise</span> <span class="ow">and</span> <span class="n">event_msg</span><span class="o">.</span><span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">:</span>
                <span class="c1"># an end of access event for a target agent has been recevied</span>

                <span class="c1"># fire end of access event</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">[</span><span class="n">event_msg</span><span class="p">]</span><span class="o">.</span><span class="n">trigger_end</span><span class="p">()</span>
                
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div></div>

<div class="viewcode-block" id="IridiumTransmitterState"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumTransmitterState">[docs]</a><span class="k">class</span> <span class="nc">IridiumTransmitterState</span><span class="p">(</span><span class="n">ComponentState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">power_consumed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">power_supplied</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">buffer_capacity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">buffer_allocated</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">TRANSMITTER</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">TransmitterComponent</span><span class="p">,</span> <span class="n">power_consumed</span><span class="p">,</span> <span class="n">power_supplied</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">=</span> <span class="n">buffer_capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="n">buffer_allocated</span>

<div class="viewcode-block" id="IridiumTransmitterState.from_component"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumTransmitterState.from_component">[docs]</a>    <span class="k">def</span> <span class="nf">from_component</span><span class="p">(</span><span class="n">transmitter</span><span class="p">:</span> <span class="n">TransmitterComponent</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TransmitterState</span><span class="p">(</span><span class="n">transmitter</span><span class="o">.</span><span class="n">power_consumed</span><span class="p">,</span> <span class="n">transmitter</span><span class="o">.</span><span class="n">power_supplied</span><span class="p">,</span> <span class="n">transmitter</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="p">,</span> <span class="n">transmitter</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="p">,</span> <span class="n">transmitter</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">transmitter</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="IridiumReceiverComponent"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumReceiverComponent">[docs]</a><span class="k">class</span> <span class="nc">IridiumReceiverComponent</span><span class="p">(</span><span class="n">ComponentModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">parent_subsystem</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span>
                <span class="n">average_power_consumption</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">buffer_capacity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span>
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">,</span> 
                <span class="n">f_update</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describes a radio receiver capable of sending messages to other agents</span>

<span class="sd">        parent_subsystem:</span>
<span class="sd">            parent comms subsystem</span>
<span class="sd">        average_power_consumption:</span>
<span class="sd">            average power consumption in [W]</span>
<span class="sd">        buffer_capacity:</span>
<span class="sd">            size of the buffer in [Mbytes]</span>
<span class="sd">        health:</span>
<span class="sd">            health of the component</span>
<span class="sd">        status:</span>
<span class="sd">            status of the component</span>
<span class="sd">        f_update:</span>
<span class="sd">            frequency of periodic state checks in [Hz]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">RECEIVER</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_subsystem</span><span class="p">,</span> <span class="n">IridiumReceiverState</span><span class="p">,</span> <span class="n">average_power_consumption</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">f_update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">=</span> <span class="n">buffer_capacity</span> <span class="o">*</span> <span class="mf">1e6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="IridiumReceiverComponent.activate"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumReceiverComponent.activate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ReceiveMessageTransmission</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span></div>

<div class="viewcode-block" id="IridiumReceiverComponent.is_critical"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumReceiverComponent.is_critical">[docs]</a>    <span class="k">def</span> <span class="nf">is_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_critical</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">-</span><span class="n">threshold</span> </div>

<div class="viewcode-block" id="IridiumReceiverComponent.is_failed"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumReceiverComponent.is_failed">[docs]</a>    <span class="k">def</span> <span class="nf">is_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_failed</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">&gt;=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="IridiumReceiverComponent.perform_task"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumReceiverComponent.perform_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">perform_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">ComponentTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskStatus</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Listens for any incoming transmissions. Needs to be told to start a ReceiveMessageTransmission</span>
<span class="sd">        task from its parent subsystem or CNDH subsystem at the beginning of the simulation otherwise</span>
<span class="sd">        all messages will not be received</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># check if component was the intended performer of this task</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">component</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component task not intended for this component. Initially intended for component </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">. Aborting task...&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ReceiveMessageTransmission</span><span class="p">):</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># gain access to incoming agent message port from parent agent</span>
                <span class="n">parent_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span>

                <span class="k">await</span> <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_in_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">msg_dict</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># listen for messages from other agents</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Waiting for agent messages...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                    <span class="n">msg_json</span> <span class="o">=</span> <span class="k">await</span> <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_in</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Agent message received!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                    <span class="n">blank</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">blank_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">blank</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_in</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">blank_json</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">InterNodeMessage</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">msg_json</span><span class="p">)</span>
                    <span class="n">msg_dict</span> <span class="o">=</span> <span class="n">InterNodeMessage</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="c1"># check if message can fit in incoming buffer</span>
                    <span class="n">msg_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg_dict</span><span class="p">)</span>
                    <span class="n">msg_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

                    <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">+</span> <span class="n">msg_length</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">+=</span> <span class="n">msg_length</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Incoming message of length </span><span class="si">{</span><span class="n">msg_length</span><span class="si">}</span><span class="s1"> now stored in incoming buffer (current state: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>
                
                        <span class="c1"># handle request</span>
                        <span class="n">msg_type</span> <span class="p">:</span> <span class="n">InterNodeMessageTypes</span> <span class="o">=</span> <span class="n">InterNodeMessageTypes</span><span class="p">[</span><span class="n">msg_dict</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]]</span>

                        <span class="k">if</span> <span class="n">msg_type</span> <span class="ow">is</span> <span class="n">InterNodeMessageTypes</span><span class="o">.</span><span class="n">PRINT_MESSAGE</span><span class="p">:</span>
                            <span class="c1"># unpack message</span>
                            <span class="n">msg</span> <span class="p">:</span> <span class="n">PrintMessage</span> <span class="o">=</span> <span class="n">PrintMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">msg_dict</span><span class="p">)</span>
                            
                            <span class="c1"># handle message </span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received print instruction: </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>

                        <span class="c1"># elif msg_type is InterNodeMessageTypes.PLANNER_MESSAGE:</span>
                        <span class="c1">#     pass</span>
                        <span class="k">elif</span> <span class="n">msg_type</span> <span class="ow">is</span> <span class="n">InterNodeMessageTypes</span><span class="o">.</span><span class="n">MEASUREMENT_REQUEST</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="p">:</span> <span class="n">InterNodeMessage</span> <span class="o">=</span> <span class="n">InterNodeMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">msg_dict</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Internodemessage type is </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                            <span class="n">ext_msg</span> <span class="o">=</span> <span class="n">InternalMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ComponentNames</span><span class="o">.</span><span class="n">TRANSMITTER</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Internal message type is </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sending measurement request to other agents (hopefully)!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">ext_msg</span><span class="p">)</span> <span class="c1"># send measurement request to all other agents</span>
                        <span class="k">elif</span> <span class="n">msg_type</span> <span class="ow">is</span> <span class="n">InterNodeMessageTypes</span><span class="o">.</span><span class="n">DOWNLINK</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="p">:</span> <span class="n">InterNodeDownlinkMessage</span> <span class="o">=</span> <span class="n">InterNodeDownlinkMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">msg_dict</span><span class="p">)</span>
                            <span class="n">data_msg</span> <span class="o">=</span> <span class="n">DataMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
                            <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">data_msg</span><span class="o">.</span><span class="n">get_target</span><span class="p">()</span>
                            <span class="n">metadata</span> <span class="o">=</span> <span class="n">data_msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Receiving result from (</span><span class="si">{</span><span class="n">lat</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">lon</span><span class="si">}</span><span class="s1">) taken at time </span><span class="si">{</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                            <span class="n">ext_msg</span> <span class="o">=</span> <span class="n">InternalMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ComponentNames</span><span class="o">.</span><span class="n">TRANSMITTER</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">ext_msg</span><span class="p">)</span> <span class="c1"># send measurement request to all other agents</span>
                        <span class="c1"># elif msg_type is InterNodeMessageTypes.MEASUREMENT_MESSAGE:</span>
                        <span class="c1">#     pass</span>
                        <span class="c1"># elif msg_type is InterNodeMessageTypes.INFORMATION_REQUEST:</span>
                        <span class="c1">#     pass</span>
                        <span class="c1"># elif msg_type is InterNodeMessageTypes.INFORMATION_MESSAGE:</span>
                        <span class="c1">#     pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Internode message of type </span><span class="si">{</span><span class="n">msg_type</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> not yet supported. Discarding message...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

                        <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">-=</span> <span class="n">msg_length</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Incoming message of length </span><span class="si">{</span><span class="n">msg_length</span><span class="si">}</span><span class="s1"> now stored in incoming buffer (current state: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Incoming buffer cannot store incoming message of length </span><span class="si">{</span><span class="n">msg_length</span><span class="si">}</span><span class="s1"> (current state: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="si">}</span><span class="s1">). Discarding message...&#39;</span><span class="p">)</span>
                    
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported.&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Aborting task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_in_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="c1"># release update lock if cancelled during task handling</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="c1"># return task abort status</span>
            <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">ABORTED</span></div>

<div class="viewcode-block" id="IridiumReceiverComponent.environment_event_handler"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumReceiverComponent.environment_event_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">environment_event_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_msg</span> <span class="p">:</span> <span class="n">EnvironmentBroadcastMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Affects the component depending on the type of event being received.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event_msg</span><span class="p">,</span> <span class="n">AgentAccessEventBroadcastMessage</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event_msg</span><span class="o">.</span><span class="n">rise</span> <span class="ow">and</span> <span class="n">event_msg</span><span class="o">.</span><span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">:</span>
                <span class="c1"># an end of access event for a target agent has been recevied</span>

                <span class="c1"># fire end of access event</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">[</span><span class="n">event_msg</span><span class="p">]</span><span class="o">.</span><span class="n">trigger_end</span><span class="p">()</span>
                
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="IridiumReceiverState"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumReceiverState">[docs]</a><span class="k">class</span> <span class="nc">IridiumReceiverState</span><span class="p">(</span><span class="n">ComponentState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">power_consumed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">power_supplied</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">buffer_capacity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">buffer_allocated</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">RECEIVER</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">IridiumReceiverComponent</span><span class="p">,</span> <span class="n">power_consumed</span><span class="p">,</span> <span class="n">power_supplied</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">=</span> <span class="n">buffer_capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="n">buffer_allocated</span>

<div class="viewcode-block" id="IridiumReceiverState.from_component"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumReceiverState.from_component">[docs]</a>    <span class="k">def</span> <span class="nf">from_component</span><span class="p">(</span><span class="n">receiver</span><span class="p">:</span> <span class="n">IridiumReceiverComponent</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">IridiumReceiverState</span><span class="p">(</span><span class="n">receiver</span><span class="o">.</span><span class="n">power_consumed</span><span class="p">,</span> <span class="n">receiver</span><span class="o">.</span><span class="n">power_supplied</span><span class="p">,</span> <span class="n">receiver</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="p">,</span> <span class="n">receiver</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="p">,</span> <span class="n">receiver</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">receiver</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="IridiumPlatformSim"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumPlatformSim">[docs]</a><span class="k">class</span> <span class="nc">IridiumPlatformSim</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_module</span> <span class="p">:</span> <span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">EngineeringModuleParts</span><span class="o">.</span><span class="n">IRIDIUM_PLATFORM_SIMULATION</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_module</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulates the agent&#39;s platform including all components and subsystems that comprise the agent.</span>
<span class="sd">        Can receive instructions via internal messages of type &#39;PlatformTaskMessage&#39;, &#39;SubsystemTaskMessage&#39;,</span>
<span class="sd">        or &#39;ComponentTaskMessage&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># TODO create list of subsystems based on component list given to the platform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">IridiumCommsSubsystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="c1"># TODO include internal state routing that kills the platform sim and the agent if a platform-level failure is detected    </span>

<div class="viewcode-block" id="IridiumPlatformSim.internal_message_handler"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumPlatformSim.internal_message_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">internal_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InternalMessage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forwards any task to the command and data handling subsystem</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dst_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span>
            <span class="k">if</span> <span class="n">dst_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="c1"># this module is NOT the intended receiver for this message. Forwarding to rightful destination</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># this module is the intended receiver for this message. Handling message</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Internal messages with contents of type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported. Discarding message.&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">--------------------------------------------------------</span>
<span class="sd"> ____                                                                              </span>
<span class="sd">/\  _`\                   __                                __                     </span>
<span class="sd">\ \ \L\_\    ___      __ /\_\    ___      __     __   _ __ /\_\    ___      __     </span>
<span class="sd"> \ \  _\L  /&#39; _ `\  /&#39;_ `\/\ \ /&#39; _ `\  /&#39;__`\ /&#39;__`\/\`&#39;__\/\ \ /&#39; _ `\  /&#39;_ `\   </span>
<span class="sd">  \ \ \L\ \/\ \/\ \/\ \L\ \ \ \/\ \/\ \/\  __//\  __/\ \ \/ \ \ \/\ \/\ \/\ \L\ \  </span>
<span class="sd">   \ \____/\ \_\ \_\ \____ \ \_\ \_\ \_\ \____\ \____\\ \_\  \ \_\ \_\ \_\ \____ \ </span>
<span class="sd">    \/___/  \/_/\/_/\/___L\ \/_/\/_/\/_/\/____/\/____/ \/_/   \/_/\/_/\/_/\/___L\ \</span>
<span class="sd">                      /\____/                                               /\____/</span>
<span class="sd">                      \_/__/                                                \_/__/    </span>
<span class="sd"> /&#39;\_/`\            /\ \         /\_ \            </span>
<span class="sd">/\      \    ___    \_\ \  __  __\//\ \      __   </span>
<span class="sd">\ \ \__\ \  / __`\  /&#39;_` \/\ \/\ \ \ \ \   /&#39;__`\ </span>
<span class="sd"> \ \ \_/\ \/\ \L\ \/\ \L\ \ \ \_\ \ \_\ \_/\  __/ </span>
<span class="sd">  \ \_\\ \_\ \____/\ \___,_\ \____/ /\____\ \____\</span>
<span class="sd">   \/_/ \/_/\/___/  \/__,_ /\/___/  \/____/\/____/                                                                                                                                                    </span>
<span class="sd">--------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="IridiumEngineeringModule"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumEngineeringModule">[docs]</a><span class="k">class</span> <span class="nc">IridiumEngineeringModule</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_agent</span> <span class="p">:</span> <span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">AgentModuleTypes</span><span class="o">.</span><span class="n">IRIDIUM_ENGINEERING_MODULE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_agent</span><span class="p">,</span> <span class="p">[],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">IridiumPlatformSim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="p">]</span>

<div class="viewcode-block" id="IridiumEngineeringModule.internal_message_handler"><a class="viewcode-back" href="../iridium_engineering.html#iridium_engineering.IridiumEngineeringModule.internal_message_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">internal_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InternalMessage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forwards any task to the platform simulator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dst_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span>
            <span class="k">if</span> <span class="n">dst_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="c1"># this module is NOT the intended receiver for this message. Forwarding to rightful destination</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">PlatformTaskMessage</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">SubsystemTaskMessage</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ComponentTaskMessage</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received a tasks message. Forwarding to </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">EngineeringModuleParts</span><span class="o">.</span><span class="n">PLATFORM_SIMULATION</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> for handling.&#39;</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span> <span class="o">=</span> <span class="n">EngineeringModuleParts</span><span class="o">.</span><span class="n">PLATFORM_SIMULATION</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># this module is the intended receiver for this message. Handling message</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Internal messages with contents of type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported. Discarding message.&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">3D-CHESS</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">dmas</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Alan Aguilar Jaramillo, Ben Gorr.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.2.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>