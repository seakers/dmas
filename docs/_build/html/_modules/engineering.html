
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>engineering &#8212; 3D-CHESS 0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for engineering</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">asyncio</span> <span class="kn">import</span> <span class="n">CancelledError</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">messages</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">modules</span> <span class="kn">import</span> <span class="n">Module</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">--------------------------------------------------------</span>
<span class="sd"> ________  ___  ___  ________  ________       ___    ___ ________  _________  _______   _____ ______      </span>
<span class="sd">|\   ____\|\  \|\  \|\   __  \|\   ____\     |\  \  /  /|\   ____\|\___   ___\\  ___ \ |\   _ \  _   \    </span>
<span class="sd">\ \  \___|\ \  \\\  \ \  \|\ /\ \  \___|_    \ \  \/  / | \  \___|\|___ \  \_\ \   __/|\ \  \\\__\ \  \   </span>
<span class="sd"> \ \_____  \ \  \\\  \ \   __  \ \_____  \    \ \    / / \ \_____  \   \ \  \ \ \  \_|/_\ \  \\|__| \  \  </span>
<span class="sd">  \|____|\  \ \  \\\  \ \  \|\  \|____|\  \    \/  /  /   \|____|\  \   \ \  \ \ \  \_|\ \ \  \    \ \  \ </span>
<span class="sd">    ____\_\  \ \_______\ \_______\____\_\  \ __/  / /       ____\_\  \   \ \__\ \ \_______\ \__\    \ \__\</span>
<span class="sd">   |\_________\|_______|\|_______|\_________\\___/ /       |\_________\   \|__|  \|_______|\|__|     \|__|</span>
<span class="sd">   \|_________|                  \|_________\|___|/        \|_________|                                   </span>

<span class="sd"> _____ ______   ________  ________  ___  ___  ___       _______   ________      </span>
<span class="sd">|\   _ \  _   \|\   __  \|\   ___ \|\  \|\  \|\  \     |\  ___ \ |\   ____\     </span>
<span class="sd">\ \  \\\__\ \  \ \  \|\  \ \  \_|\ \ \  \\\  \ \  \    \ \   __/|\ \  \___|_    </span>
<span class="sd"> \ \  \\|__| \  \ \  \\\  \ \  \ \\ \ \  \\\  \ \  \    \ \  \_|/_\ \_____  \   </span>
<span class="sd">  \ \  \    \ \  \ \  \\\  \ \  \_\\ \ \  \\\  \ \  \____\ \  \_|\ \|____|\  \  </span>
<span class="sd">   \ \__\    \ \__\ \_______\ \_______\ \_______\ \_______\ \_______\____\_\  \ </span>
<span class="sd">    \|__|     \|__|\|_______|\|_______|\|_______|\|_______|\|_______|\_________\</span>
<span class="sd">                                                                    \|_________|</span>
<span class="sd">--------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">-------------------------------</span>
<span class="sd">CCOMPONENT MODULES</span>
<span class="sd">-------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="ComponentModule"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule">[docs]</a><span class="k">class</span> <span class="nc">ComponentModule</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                <span class="n">parent_subsystem</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span>   
                <span class="n">component_state</span> <span class="p">:</span> <span class="nb">type</span><span class="p">,</span> 
                <span class="n">average_power_consumption</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">health</span> <span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span>
                <span class="n">status</span> <span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">OFF</span><span class="p">,</span>
                <span class="n">f_update</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">n_timed_coroutines</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describes a generic component of an agent&#39;s platform.</span>

<span class="sd">        name:</span>
<span class="sd">            name of the component</span>
<span class="sd">        parent_subsystem:</span>
<span class="sd">            subsystem that this component belongs to</span>
<span class="sd">        component_state:</span>
<span class="sd">            type of component state describing this component&#39;s state</span>
<span class="sd">        average_power_consumption:</span>
<span class="sd">            average power consumption in [W]</span>
<span class="sd">        health:</span>
<span class="sd">            health of the component</span>
<span class="sd">        status:</span>
<span class="sd">            status of the component</span>
<span class="sd">        f_update:</span>
<span class="sd">            frequency of periodic state checks in [Hz]</span>
<span class="sd">        n_timed_coroutines:</span>
<span class="sd">            number of time-dependent corroutines being performed by this component</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent_subsystem</span><span class="p">,</span> <span class="p">[],</span> <span class="n">n_timed_coroutines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_FREQUENCY</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">f_update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">component_state</span> <span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">component_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">average_power_consumption</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">average_power_consumption</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_update</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">health</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">status</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">power_consumed</span> <span class="p">:</span> <span class="nb">float</span><span class="o">=</span> <span class="mf">0.0</span>                                <span class="c1"># power currently being consumed by this component</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_supplied</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>                               <span class="c1"># power currently being fed to this component       </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_supplied</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_consumed</span>     <span class="c1"># curent difference between power in and power usage</span>

<div class="viewcode-block" id="ComponentModule.activate"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.activate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

        <span class="c1"># component status events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>                                  <span class="c1"># fires when the component is enabled or turned on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>                                 <span class="c1"># fires when the component is disabled or turned off</span>

        <span class="c1"># component health events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nominal</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>                                  <span class="c1"># fires when the component enters a nominal state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">critical</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>                                 <span class="c1"># fires when the component enters a critical state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>                                  <span class="c1"># fires when the component enters a failure state</span>

        <span class="c1"># trigger health events</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nominal</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">CRITIAL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">FAILURE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="c1"># component update event    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>                                  <span class="c1"># informs other processes that the component&#39;s state has been updated</span>

        <span class="c1"># task queues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maintenance_tasks</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>                        <span class="c1"># stores maintenance task commands to be executed by this component</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>                                    <span class="c1"># stores action task commands to be executed by this component</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aborts</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>                                   <span class="c1"># stores task abort commnands to be executed by this component</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_events</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>                       <span class="c1"># stores environment events that may have an effect on this component</span>

        <span class="c1"># initiate update time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_update</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_time</span><span class="p">()</span>                 <span class="c1"># tracks when the last component update was performed</span>

        <span class="c1"># update state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>                                <span class="c1"># prevents two internal processes from affecting the component&#39;s state simultaneously  </span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>        

        <span class="c1"># request power if on at the beginning of the simulation</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_power_consumption</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Component is ON. Requesting power from EPS&#39;</span><span class="p">)</span>

            <span class="c1"># ask for power supply from eps</span>
            <span class="n">power_supply_task</span> <span class="o">=</span> <span class="n">PowerSupplyRequestTask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_power_consumption</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">SubsystemTaskMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">SubsystemNames</span><span class="o">.</span><span class="n">EPS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">power_supply_task</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Component is ON&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="ComponentModule.internal_message_handler"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.internal_message_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">internal_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InternalMessage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes messages being sent to this component. Only accepts task messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="c1"># this module is NOT the intended receiver for this message. Forwarding to rightful destination</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received internal message intended for </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span><span class="si">}</span><span class="s1">. Rerouting message...&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ComponentTaskMessage</span><span class="p">):</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_task</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received a task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ComponentAbortTask</span><span class="p">):</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">aborts</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ComponentMaintenanceTask</span><span class="p">):</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">maintenance_tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">EnvironmentBroadcastMessage</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received an environment event of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environment_events</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Internal message of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported. Discarding message...&#39;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span>    </div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --------------------</span>
<span class="sd">    CO-ROUTINES</span>
<span class="sd">    --------------------</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ComponentModule.coroutines"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.coroutines">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">coroutines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Each component is in charge of the following routines:</span>

<span class="sd">        1- Periodically monitoring its own state</span>

<span class="sd">        2- Detecting critical states</span>

<span class="sd">        3- Triggering failure states</span>

<span class="sd">        4- Perform tasks being given to this component</span>

<span class="sd">        5- Processes events from the environment that may affect this component</span>
<span class="sd">        </span>
<span class="sd">        Component failure leads to no actions being able to be performed by this </span>
<span class="sd">        component. Subsystem-wide failure is to be handled by their parent subsystem.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># create coroutine tasks</span>
        <span class="n">coroutines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1">## Internal coroutines</span>
            <span class="n">periodic_update</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periodic_update</span><span class="p">())</span>
            <span class="n">periodic_update</span><span class="o">.</span><span class="n">set_name</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_periodic_update&#39;</span><span class="p">)</span>
            <span class="n">coroutines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">periodic_update</span><span class="p">)</span>
        
            <span class="c1"># crit_monitor = asyncio.create_task(self.crit_monitor())</span>
            <span class="c1"># crit_monitor.set_name (f&#39;{self.name}_crit_monitor&#39;)</span>
            <span class="c1"># #coroutines.append(crit_monitor)</span>

            <span class="c1"># failure_monitor = asyncio.create_task(self.failure_monitor())</span>
            <span class="c1"># failure_monitor.set_name (f&#39;{self.name}_failure_monitor&#39;)</span>
            <span class="c1"># #coroutines.append(failure_monitor)</span>

            <span class="n">maintenance_task_processor</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maintenance_task_processor</span><span class="p">())</span>
            <span class="n">maintenance_task_processor</span><span class="o">.</span><span class="n">set_name</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_maintenance_task_processor&#39;</span><span class="p">)</span>
            <span class="n">coroutines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maintenance_task_processor</span><span class="p">)</span>

            <span class="n">task_processor</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_processor</span><span class="p">())</span>
            <span class="n">task_processor</span><span class="o">.</span><span class="n">set_name</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_task_processor&#39;</span><span class="p">)</span>
            <span class="n">coroutines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_processor</span><span class="p">)</span>

            <span class="n">environment_event_processor</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_event_processor</span><span class="p">())</span>
            <span class="n">environment_event_processor</span><span class="o">.</span><span class="n">set_name</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_environment_event_processor&#39;</span><span class="p">)</span>
            <span class="n">coroutines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">environment_event_processor</span><span class="p">)</span>

            <span class="c1"># wait for the first coroutine to complete</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">coroutines</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
            
            <span class="n">done_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">coroutine</span> <span class="ow">in</span> <span class="n">coroutines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">coroutine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                    <span class="n">coroutine</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span>
                    <span class="n">done_name</span> <span class="o">=</span> <span class="n">coroutine</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
                    <span class="k">break</span>

            <span class="c1"># cancell all other coroutine tasks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">done_name</span><span class="si">}</span><span class="s1"> Coroutine ended. Terminating all other coroutines...&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">subroutine</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                <span class="n">subroutine</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span>
                <span class="n">subroutine</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">subroutine</span>
            
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coroutines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">coroutine</span> <span class="ow">in</span> <span class="n">coroutines</span><span class="p">:</span>
                    <span class="n">coroutine</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">coroutine</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                        <span class="n">coroutine</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                        <span class="k">await</span> <span class="n">coroutine</span></div>

<div class="viewcode-block" id="ComponentModule.periodic_update"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.periodic_update">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">periodic_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs periodic update of the component&#39;s state when the component is Enabled</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># wait for next periodic update</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Waiting for next update period...&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_FREQUENCY</span><span class="p">)</span>

                <span class="c1"># update component state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Performing periodic state update...&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Periodic state update completed!&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">OFF</span><span class="p">:</span>
                    <span class="c1"># if component is turned off, wait until it is turned on</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component is off. Waiting until it is turned on again to restart periodic updates...&#39;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">FAILURE</span><span class="p">:</span>
                    <span class="c1"># else if component is in failure state, stop periodic updates and sleep for the rest of the simu</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component is in a failure state. Stopping periodic updates until the end of the simulation...&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="c1"># inform parent subsystem of current state</span>
                
                <span class="c1"># if self.health is ComponentHealth.NOMINAL:</span>
                <span class="c1">#     self.log(f&#39;Component state is nominal. Sharing state with parent subsystem.&#39;)</span>
                <span class="c1">#     state : ComponentState = await self.get_state()</span>
                <span class="c1">#     msg = ComponentStateMessage(self.name, self.parent_module.name, state)</span>
                <span class="c1">#     await self.send_internal_message(msg)                  </span>
                
                <span class="c1"># TODO: uncomment previous 5 lines and comment out the next 4 lines whenever crit and failure monitures are activated</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sharing state with parent subsystem.&#39;</span><span class="p">)</span>
                <span class="n">state</span> <span class="p">:</span> <span class="n">ComponentState</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">ComponentStateMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Periodic update completed!&#39;</span><span class="p">)</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># sleep for the rest of the simulation</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="ComponentModule.crit_monitor"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.crit_monitor">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">crit_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monitors component state after every component state update and communicates critical state </span>
<span class="sd">        to parent subsystem and other processes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># check if failure event was triggered</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">FAILURE</span><span class="p">:</span>
                    <span class="c1"># if component is in failure state, sleep for the remainder of the simulation</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># wait for next state update </span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

                    <span class="c1"># get latest state and acquire state lock</span>
                    <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">CRITIAL</span><span class="p">:</span>
                        <span class="c1"># component is in critical state</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                            <span class="c1"># release state lock</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                            <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>
                            
                            <span class="c1"># inform parent subsystem of component critical state</span>
                            <span class="n">state</span> <span class="p">:</span> <span class="n">ComponentState</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="n">ComponentStateMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>                          

                            <span class="c1"># trigger critical state event                             </span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    
                    <span class="c1"># release state lock</span>
                    <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="ComponentModule.is_critical"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.is_critical">[docs]</a>    <span class="k">def</span> <span class="nf">is_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns true if the current state of the component is critical. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="ComponentModule.failure_monitor"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.failure_monitor">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">failure_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monitors component state and triggers failure event if a failure state is detected</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> 
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">FAILURE</span><span class="p">:</span>
                    <span class="c1"># if comonent is in failure state, sleep for the rest of the simulation</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># initiate failure state timer</span>
                    <span class="n">failure_timer</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_for_failure</span><span class="p">())</span>
                    <span class="n">update_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">wait</span><span class="p">())</span>
                    
                    <span class="c1"># wait for the failure timer to run out or for the component to update its state</span>
                    <span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span><span class="n">update_event</span><span class="p">,</span> <span class="n">failure_timer</span><span class="p">]</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">update_event</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                        <span class="c1"># component was updated before the component&#39;s failure timer ran out</span>

                        <span class="c1"># cancel failure timer</span>
                        <span class="n">failure_timer</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                        <span class="k">await</span> <span class="n">failure_timer</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># component&#39;s failure timer ran out before the component had changed its state or configuration</span>

                        <span class="c1"># update state</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

                    <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">CRITIAL</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_failed</span><span class="p">():</span>
                        <span class="c1"># component is in a potential failure state</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>                            
                            <span class="c1"># failure event has not been triggered yet</span>

                            <span class="c1"># release state lock</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                            <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="c1"># give parent subsystem or agent one update cycle to respond to potential failure</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_FREQUENCY</span><span class="p">)</span>

                            <span class="c1"># update state</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                            
                            <span class="c1"># check if component is still in a potential failure state</span>
                            <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_failed</span><span class="p">():</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_power_supply_failure</span><span class="p">():</span>                                    
                                    <span class="c1"># component is in a non-power-related failure state, triggering failure sequence</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">FAILURE</span>

                                    <span class="c1"># trigger failure event</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">nominal</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>               
                                
                                <span class="c1"># release state lock</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>      
                                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>    

                                <span class="c1"># update state</span>
                                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>                       

                                <span class="c1"># task component to disable itself</span>
                                <span class="n">task</span> <span class="o">=</span> <span class="n">ComponentActuationTask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">OFF</span><span class="p">)</span>
                                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">maintenance_tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

                                <span class="c1"># communicate parent subsystem of component failure state</span>
                                <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="n">ComponentStateMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            
                    <span class="c1"># release state lock</span>
                    <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="ComponentModule.is_power_supply_failure"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.is_power_supply_failure">[docs]</a>    <span class="k">def</span> <span class="nf">is_power_supply_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns true if current state is a power supply failure state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">power_consumed</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_supplied</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">1e-6</span></div>

<div class="viewcode-block" id="ComponentModule.is_failed"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.is_failed">[docs]</a>    <span class="k">def</span> <span class="nf">is_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns true if the current state of the component is a failure state. </span>
<span class="sd">        By default it only considers power supply vs power consumption. Can be extended to add more functionality</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_power_supply_failure</span><span class="p">()</span></div>

<div class="viewcode-block" id="ComponentModule.wait_for_failure"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.wait_for_failure">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts down to the next predicted failure state of this component given that the current configuration is maintained</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div>


    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --------------------</span>
<span class="sd">    TASKS AND EVENT HANDLER</span>
<span class="sd">    --------------------</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ComponentModule.maintenance_task_processor"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.maintenance_task_processor">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">maintenance_task_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes maintenance tasks in the order they are received.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># wait for next incoming maintnance task</span>
                <span class="n">task</span> <span class="p">:</span> <span class="n">ComponentTask</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">maintenance_tasks</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ComponentMaintenanceTask</span><span class="p">):</span>
                    <span class="c1"># if task is NOT a maintenance ask, move to proper queue</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                    <span class="k">return</span>
                
                <span class="c1"># update component state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting execution of task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">! Updating component state...&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">TaskStatus</span><span class="o">.</span><span class="n">IN_PROCESS</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">ACTIONS</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">crit_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># perform task </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component state updated! Performing task...&#39;</span><span class="p">)</span>
                <span class="n">status</span> <span class="p">:</span> <span class="n">TaskStatus</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">perform_maintenance_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

                <span class="c1"># update component state </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Updating comopnent state...&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

                <span class="c1"># inform parent subsystem of the status of completion of the task at hand</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component state updated! Informing parent subsystem of task completion status: </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">...&#39;</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">ComponentTaskCompletionMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="c1"># inform parent subsytem of the current component state</span>
                <span class="n">state</span> <span class="p">:</span> <span class="n">ComponentState</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component state updated and health is </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">! Informing parent subsystem of component health...&#39;</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">ComponentStateMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component state communicated to parent subsystem! Finished processing task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component state updated! Finished processing task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Performed task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

                <span class="c1"># log task completion status</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">ACTIONS</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="ComponentModule.perform_maintenance_task"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.perform_maintenance_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">perform_maintenance_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">ComponentMaintenanceTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskStatus</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a maintenance task given to this component. </span>
<span class="sd">        Rejects any tasks that is not intended to be performed by this component. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>

            <span class="c1"># check if component was the intended performer of this task</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">component</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component task not intended for this component. Initially intended for component </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">. Aborting task...&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

            <span class="c1"># check if the component or subsystem is disabled or in a failure state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span> <span class="p">:</span> <span class="n">SubsystemModule</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">SubsystemHealth</span><span class="o">.</span><span class="n">FAILURE</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">EnableComponentTask</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subsystem is in failure state. Cannot turn on component.&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">FAILURE</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">EnableComponentTask</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component is in failure state. Cannot turn on component.&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ComponentActuationTask</span><span class="p">):</span>          
                <span class="c1"># obtain state lock</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Awaiting to acquire state lock...&#39;</span><span class="p">)</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

                <span class="c1"># actuate component</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">actuation_status</span> <span class="ow">is</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;State lock acquired! Turning on component...&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">:</span>
                        <span class="c1"># turn component on</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">disabled</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

                        <span class="c1"># ask for power supply from eps</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component has been turned on and state lock has been released! Communicating increase of power draw to EPS...&#39;</span><span class="p">)</span>
                        <span class="n">power_supply_task</span> <span class="o">=</span> <span class="n">PowerSupplyRequestTask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_power_consumption</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">SubsystemTaskMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">SubsystemNames</span><span class="o">.</span><span class="n">EPS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">power_supply_task</span><span class="p">)</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Increase of power draw communicated to EPS! Actuation task successfully performed!&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># release state lock</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component is already on. Aborting task...&#39;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>  

                <span class="k">elif</span> <span class="n">task</span><span class="o">.</span><span class="n">actuation_status</span> <span class="ow">is</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">OFF</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;State lock acquired! Turning off component...&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">OFF</span><span class="p">:</span>
                        <span class="c1"># turn component off</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">OFF</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">disabled</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

                        <span class="c1"># ask for end of power supply from eps</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component has been turned off and state lock has been released! Communicating loss of power draw to EPS...&#39;</span><span class="p">)</span>
                        <span class="n">stop_power_supply_task</span> <span class="o">=</span> <span class="n">PowerSupplyRequestTask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">average_power_consumption</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">SubsystemTaskMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">SubsystemNames</span><span class="o">.</span><span class="n">EPS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">stop_power_supply_task</span><span class="p">)</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loss of power draw communicated to EPS! Actuation task sucessfully performed!&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># release state lock</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component is already off. Aborting task...&#39;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>    

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># release state lock</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component Status </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">actuation_status</span><span class="si">}</span><span class="s1"> not supported for component actuation.&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

                <span class="c1"># release state lock</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># return task completion status</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component status set to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">DONE</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ReceivePowerTask</span><span class="p">):</span>
                <span class="c1"># obtain state lock</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Awaiting to acquire state lock...&#39;</span><span class="p">)</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

                <span class="c1"># provide change in power supply</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;State lock acquired! Changing power received by this component...&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">power_supplied</span> <span class="o">+=</span> <span class="n">task</span><span class="o">.</span><span class="n">power_to_receive</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_supplied</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">power_supplied</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># release state lock</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># return task completion status</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component power supply successfully modified and state lock has been released! Component just received power supply of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">power_supplied</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">DONE</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported.&#39;</span><span class="p">)</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span> 
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> was aborted.&#39;</span><span class="p">)</span>

            <span class="c1"># release update lock if cancelled during task handling</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="c1"># return task abort status</span>
            <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">ABORTED</span></div>


<div class="viewcode-block" id="ComponentModule.task_processor"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.task_processor">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">task_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes tasks in the order they are received. Listens for any abort commands that may be received during </span>
<span class="sd">        the performance of the task and processes them accordingly. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># initialize task variables</span>
            <span class="n">perform_task</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">listen_for_abort</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">task</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ComponentMaintenanceTask</span><span class="p">):</span>
                    <span class="c1"># if task is NOT a maintenance ask, move to proper queue</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">maintenance_tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">TaskStatus</span><span class="o">.</span><span class="n">IN_PROCESS</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">ACTIONS</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

                <span class="c1"># update component state</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

                <span class="c1"># start to perform task</span>
                <span class="n">perform_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perform_task</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
                <span class="n">listen_for_abort</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listen_for_abort</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
                <span class="n">wait_for_subsystem_failure</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">failure</span><span class="o">.</span><span class="n">wait</span><span class="p">())</span>
                <span class="n">wait_for_component_failure</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="o">.</span><span class="n">wait</span><span class="p">())</span>
                <span class="n">wait_for_disabled_subsystem</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">disabled</span><span class="o">.</span><span class="n">wait</span><span class="p">())</span>
                <span class="n">wait_for_disabled_component</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disabled</span><span class="o">.</span><span class="n">wait</span><span class="p">())</span>
                
                <span class="n">perform_task</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">listen_for_abort</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ListenForAbort&#39;</span><span class="p">)</span>
                <span class="n">wait_for_subsystem_failure</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WaitForSubsystemFailure&#39;</span><span class="p">)</span>
                <span class="n">wait_for_component_failure</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s1">&#39;WaitForComponentFailure&#39;</span><span class="p">)</span>
                <span class="n">wait_for_disabled_subsystem</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s1">&#39;WaitForDisabledSubsystem&#39;</span><span class="p">)</span>
                <span class="n">wait_for_disabled_component</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s1">&#39;WaitForDisabledComponent&#39;</span><span class="p">)</span>

                <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span><span class="n">perform_task</span><span class="p">,</span> 
                            <span class="n">listen_for_abort</span><span class="p">,</span> 
                            <span class="n">wait_for_subsystem_failure</span><span class="p">,</span> 
                            <span class="n">wait_for_component_failure</span><span class="p">,</span> 
                            <span class="n">wait_for_disabled_subsystem</span><span class="p">,</span>
                            <span class="n">wait_for_disabled_component</span><span class="p">]</span>

                <span class="c1"># wait for task completion, abort command, or component or subsystem failure</span>
                <span class="n">done</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">perform_task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> successfully completed! Task status: </span><span class="si">{</span><span class="n">perform_task</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">done_process</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                        <span class="n">done_process</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">done_process</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s1"> completed before the task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> was successfully completed&#39;</span><span class="p">)</span>
                
                <span class="c1"># get task completion status</span>
                <span class="n">status</span> <span class="p">:</span> <span class="n">TaskStatus</span> <span class="o">=</span> <span class="n">perform_task</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                
                <span class="c1"># cancell all pending processes</span>
                <span class="k">for</span> <span class="n">pending_process</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                    <span class="n">pending_process</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span>

                    <span class="k">if</span> <span class="s1">&#39;Wait&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pending_process</span><span class="o">.</span><span class="n">get_name</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Aborting </span><span class="si">{</span><span class="n">pending_process</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
                        <span class="n">pending_process</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                        <span class="k">await</span> <span class="n">pending_process</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pending_process</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s1"> successfully aborted.&#39;</span><span class="p">)</span>

                <span class="c1"># inform parent subsystem of the status of completion of the task at hand</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Informing parent subsystem about task completion status...&#39;</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">ComponentTaskCompletionMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">perform_task</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="c1"># update component state </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task completion communicated! Updating state...&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

                <span class="c1"># inform parent subsytem of the current component state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;State updated! Informing parent subsystem about component state...&#39;</span><span class="p">)</span>
                <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">ComponentStateMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_module</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component state communicated! Finished processing task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>

                <span class="c1"># log task completion</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">ACTIONS</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">perform_task</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">perform_task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="n">perform_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">perform_task</span>
            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">listen_for_abort</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">listen_for_abort</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="n">listen_for_abort</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">listen_for_abort</span></div>

<div class="viewcode-block" id="ComponentModule.listen_for_abort"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.listen_for_abort">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">listen_for_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">ComponentTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Listens for any abort command targetted towards the task being performed.</span>
<span class="sd">        Any aborts targetted to other tasks are ignored but not discarded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">other_aborts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">abort_task</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">aborts</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">abort_task</span> <span class="o">==</span> <span class="n">task</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">abort</span> <span class="ow">in</span> <span class="n">other_aborts</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">aborts</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">abort</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received abort command for task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">other_aborts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">abort_task</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">abort</span> <span class="ow">in</span> <span class="n">other_aborts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aborts</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">abort</span><span class="p">)</span></div>


<div class="viewcode-block" id="ComponentModule.perform_task"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.perform_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">perform_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">ComponentTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskStatus</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a task given to this component. </span>
<span class="sd">        Rejects any tasks that is not intended to be performed by this component. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># check if component was the intended performer of this task</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">component</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component task not intended for this component. Initially intended for component </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">. Aborting task...&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported.&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Aborting task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

            <span class="c1"># return task abort status</span>
            <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">ABORTED</span></div>
        

<div class="viewcode-block" id="ComponentModule.environment_event_processor"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.environment_event_processor">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">environment_event_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes any incoming events from the environment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">aquired</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">environment_event_handler</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># wait for an event to be received</span>
                <span class="n">event_broadcast</span> <span class="p">:</span> <span class="n">EnvironmentBroadcastMessage</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_events</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

                <span class="c1"># update the component&#39;s state</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

                <span class="c1"># handle according to event type</span>
                <span class="n">aquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

                <span class="n">environment_event_handler</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_event_handler</span><span class="p">(</span><span class="n">event_broadcast</span><span class="p">))</span>
                <span class="k">await</span> <span class="n">environment_event_handler</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="n">aquired</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># if the handler affected the component, update its state</span>
                <span class="k">if</span> <span class="n">environment_event_handler</span><span class="o">.</span><span class="n">result</span><span class="p">():</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">aquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">environment_event_handler</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">environment_event_handler</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="n">environment_event_handler</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">environment_event_handler</span></div>


<div class="viewcode-block" id="ComponentModule.environment_event_handler"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.environment_event_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">environment_event_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_broadcast</span> <span class="p">:</span> <span class="n">EnvironmentBroadcastMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Affects the component depending on the type of event being received. Ignores all events by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --------------------</span>
<span class="sd">    HELPING FUNCTIONS</span>
<span class="sd">    --------------------</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ComponentModule.update"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.update">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crit_flag</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the state of the component. Checks if component is currently in a critical state.</span>

<span class="sd">        crit_flag:</span>
<span class="sd">            when true, it flags a critical state from being flagged at the end of the state update.</span>
<span class="sd">            It is true by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># wait for any possible state accessing process to finish</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

            <span class="c1"># calculate update time-step</span>
            <span class="n">t_curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_time</span><span class="p">()</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">t_curr</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_update</span>

            <span class="c1"># update component properties</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_properties</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

            <span class="c1"># check component health</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_critical</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_failed</span><span class="p">())</span> <span class="ow">and</span> <span class="n">crit_flag</span><span class="p">:</span>
                <span class="c1"># component is in a critical or a potential failure state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">CRITIAL</span>                    

                <span class="c1"># trigger critical state event if it hasn&#39;t been triggered already</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_critical</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># component is NOT in a critical state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span>
    
                <span class="c1"># reset critical and failure event if it has been previously triggered</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="c1"># update latest update time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_update</span> <span class="o">=</span> <span class="n">t_curr</span>  

            <span class="c1"># inform other processes that the update has finished</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="c1"># release state lock</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span> 
            <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="c1"># if this process had acquired the update_lock and has not released it, release update lock</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>    </div>

<div class="viewcode-block" id="ComponentModule.update_properties"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.update_properties">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the current state of the component given a time-step dt</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update power consumption</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power_consumed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_power_consumption</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">power_consumed</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># update power differential tracker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_supplied</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_consumed</span></div>

<div class="viewcode-block" id="ComponentModule.get_state"><a class="viewcode-back" href="../engineering.html#engineering.ComponentModule.get_state">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a state class object capturing the current state of this component </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># wait for any possible update process to finish</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Awaiting state lock...&#39;</span><span class="p">)</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>  
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;State lock acquired! Getting current state...&#39;</span><span class="p">)</span>


            <span class="c1"># get state object from component status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">component_state</span> <span class="p">:</span> <span class="n">ComponentState</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_state</span><span class="o">.</span><span class="n">from_component</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="c1"># release update lock</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;State obtained. State lock released.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">state</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="c1"># release state lock</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="k">return</span> <span class="kc">None</span></div></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">-------------------------------</span>
<span class="sd">SUBSYSTEM MODULES</span>
<span class="sd">-------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="SubsystemModule"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule">[docs]</a><span class="k">class</span> <span class="nc">SubsystemModule</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                <span class="n">parent_platform_sim</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span>   
                <span class="n">subsystem_state</span> <span class="p">:</span> <span class="nb">type</span><span class="p">,</span> 
                <span class="n">health</span> <span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span>
                <span class="n">status</span> <span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">OFF</span><span class="p">,</span>
                <span class="n">n_timed_coroutines</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describes a generic subsyem of an agent&#39;s platform.</span>

<span class="sd">        name:</span>
<span class="sd">            name of the subsystem</span>
<span class="sd">        parent_platform_sim:</span>
<span class="sd">            platform simulator that this subsystem belongs to</span>
<span class="sd">        subsystem_state:</span>
<span class="sd">            type of subsystem state describing this subsystem</span>
<span class="sd">        health:</span>
<span class="sd">            health of the subsystem</span>
<span class="sd">        status:</span>
<span class="sd">            status of the subsystem</span>
<span class="sd">        n_timed_coroutines:</span>
<span class="sd">            number of time-dependent corroutines being performed by this component</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent_platform_sim</span><span class="p">,</span> <span class="p">[],</span> <span class="n">n_timed_coroutines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsystem_state</span> <span class="o">=</span> <span class="n">subsystem_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">health</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>

<div class="viewcode-block" id="SubsystemModule.activate"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.activate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

        <span class="c1"># subssytem status events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>                                  <span class="c1"># fires when the subsystem is enabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>                                 <span class="c1"># fires when the subsystem is disabled</span>

        <span class="c1"># subsystem health events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nominal</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>                                  <span class="c1"># fires when the subsystem enters a nominal state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">critical</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>                                 <span class="c1"># fires when the subsystem enters a critical state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>                                  <span class="c1"># fires when the subsystem enters a failure state</span>

        <span class="c1"># trigger health events</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nominal</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">CRITIAL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">FAILURE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="c1"># task queues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>                                    <span class="c1"># stores task commands to be executed by this subsystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aborts</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>                                   <span class="c1"># stores task abort commnands to be executed by this subsystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">component_state_updates</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>                  <span class="c1"># stores component state updates to be processed by this subsystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsystem_state_updates</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>                  <span class="c1"># stores subsystem state updates to be processed by this subsystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recevied_task_status</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>                     <span class="c1"># stores component tasks&#39; status after they&#39;ve been submitted to components for completion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_events</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>                       <span class="c1"># stores environment events that may have an effect on this subsystem</span>

        <span class="c1"># subsystem update event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>                                  <span class="c1"># informs other processes that the subsystem&#39;s state has been updated</span>

        <span class="c1"># initiate update time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_update</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_time</span><span class="p">()</span>                 <span class="c1"># tracks when the last component update was performed</span>

        <span class="c1"># initiate state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>                               <span class="c1"># prevents two internal processes from updating the component&#39;s state simultaneously  </span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">component_states</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>                                  <span class="c1"># tracks the state of each component contained in this subsystem</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span><span class="p">:</span>
            <span class="n">component</span> <span class="p">:</span> <span class="n">ComponentModule</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">component_states</span><span class="p">[</span><span class="n">component</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">component</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="SubsystemModule.internal_message_handler"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.internal_message_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">internal_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InternalMessage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes messages being sent to this subsystem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MSG TYPE: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subsystem is in failure state. Ignoring message...&#39;</span><span class="p">)</span>
                <span class="k">return</span>
                <span class="c1"># TODO add capability to recover component by performing some troubleshooting tasks being given to this component</span>

            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="c1"># this module is NOT the intended receiver for this message. Forwarding to rightful destination</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received internal message intended for </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span><span class="si">}</span><span class="s1">. Rerouting message...&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">PlatformTaskMessage</span><span class="p">)</span> 
                  <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">SubsystemTaskMessage</span><span class="p">)</span>
                  <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ComponentTaskMessage</span><span class="p">)</span>
                  <span class="p">):</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_task</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received a task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">PlatformAbortTask</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">SubsystemAbortTask</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ComponentAbortTask</span><span class="p">):</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">aborts</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                    
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">EnvironmentBroadcastMessage</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received internal message containing an environment broadcast of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_events</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Forwarding internal message containing an environment broadcast of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1"> to components...&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span><span class="p">:</span>
                    <span class="n">component</span> <span class="p">:</span> <span class="n">ComponentModule</span>
                    <span class="n">msg_copy</span> <span class="o">=</span> <span class="n">InternalMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg_copy</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ComponentStateMessage</span><span class="p">):</span>
                <span class="n">component_state</span> <span class="p">:</span> <span class="n">ComponentState</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received component state message from component type </span><span class="si">{</span><span class="n">component_state</span><span class="o">.</span><span class="n">component_type</span><span class="si">}</span><span class="s1">. Updating subsystem state...&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_state_updates</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">component_state</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">SubsystemStateMessage</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received subsystem state message from subsystem type </span><span class="se">\&#39;</span><span class="s1">NONE</span><span class="se">\&#39;</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="n">subsystem_state</span> <span class="p">:</span> <span class="n">SubsystemState</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">subsystem_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received subsystem state message from subsystem type </span><span class="se">\&#39;</span><span class="s1">NONE</span><span class="se">\&#39;</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received subsystem state message from subsystem type </span><span class="si">{</span><span class="n">subsystem_state</span><span class="o">.</span><span class="n">subsystem_type</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsystem_state_updates</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">subsystem_state</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">SubsystemStateRequestMessage</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received a subsystem state request from subsystem </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">src_module</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">. Sending latest subsystem state...&#39;</span><span class="p">)</span>
                <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">SubsystemStateMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">src_module</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ComponentTaskCompletionMessage</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received a component task completion message from component </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">src_module</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> with status (</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get_task_status</span><span class="p">()</span><span class="si">}</span><span class="s1">). Processing response...&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">recevied_task_status</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">SubsystemTaskCompletionMessage</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received a subsystem task completion message from subsystem </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">src_module</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">. Processing response...&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">recevied_task_status</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Internal message of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported. Discarding message...&#39;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --------------------</span>
<span class="sd">    CO-ROUTINES</span>
<span class="sd">    --------------------</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SubsystemModule.coroutines"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.coroutines">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">coroutines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Each subsystem is in charge of the following routines:</span>

<span class="sd">        1- Updating subsystem state using incoming component states</span>

<span class="sd">        2- Updating knowledge of other subsystems&#39; states</span>

<span class="sd">        3- Detecting critical states</span>

<span class="sd">        4- Triggering failure states</span>

<span class="sd">        5- Perform tasks being given to this component</span>

<span class="sd">        6- Processes events from the environment that may affect this component</span>
<span class="sd">        </span>
<span class="sd">        Subsystem failure leads to no actions being able to be performed by this </span>
<span class="sd">        subsystem. Agent-wide failure is to be handled by the platform simulator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create coroutine tasks</span>
        <span class="n">coroutines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Internal coroutines</span>
            <span class="n">update_component_state</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_component_state</span><span class="p">())</span>
            <span class="n">update_component_state</span><span class="o">.</span><span class="n">set_name</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_update_component_state&#39;</span><span class="p">)</span>
            <span class="n">coroutines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">update_component_state</span><span class="p">)</span>

            <span class="n">update_subsytem_state</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_subsytem_state</span><span class="p">())</span>
            <span class="n">update_subsytem_state</span><span class="o">.</span><span class="n">set_name</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_update_subsytem_state&#39;</span><span class="p">)</span>
            <span class="n">coroutines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">update_subsytem_state</span><span class="p">)</span>

            <span class="c1"># crit_monitor = asyncio.create_task(self.crit_monitor())</span>
            <span class="c1"># crit_monitor.set_name (f&#39;{self.name}_crit_monitor&#39;)</span>
            <span class="c1">#coroutines.append(crit_monitor)</span>

            <span class="c1"># failure_monitor = asyncio.create_task(self.failure_monitor())</span>
            <span class="c1"># failure_monitor.set_name (f&#39;{self.name}_failure_monitor&#39;)</span>
            <span class="c1"># coroutines.append(failure_monitor)</span>

            <span class="n">task_processor</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_processor</span><span class="p">())</span>
            <span class="n">task_processor</span><span class="o">.</span><span class="n">set_name</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_task_processor&#39;</span><span class="p">)</span>
            <span class="n">coroutines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_processor</span><span class="p">)</span>

            <span class="n">environment_event_processor</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_event_processor</span><span class="p">())</span>
            <span class="n">environment_event_processor</span><span class="o">.</span><span class="n">set_name</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_environment_event_processor&#39;</span><span class="p">)</span>
            <span class="n">coroutines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">environment_event_processor</span><span class="p">)</span>

            <span class="c1"># wait for the first coroutine to complete</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">coroutines</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
            
            <span class="n">done_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">coroutine</span> <span class="ow">in</span> <span class="n">coroutines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">coroutine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                    <span class="n">coroutine</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span>
                    <span class="n">done_name</span> <span class="o">=</span> <span class="n">coroutine</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
                    <span class="k">break</span>

            <span class="c1"># cancell all other coroutine tasks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">done_name</span><span class="si">}</span><span class="s1"> Coroutine ended. Terminating all other coroutines...&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">subroutine</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                <span class="n">subroutine</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span>
                <span class="n">subroutine</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">subroutine</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coroutines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">coroutine</span> <span class="ow">in</span> <span class="n">coroutines</span><span class="p">:</span>
                    <span class="n">coroutine</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">coroutine</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                        <span class="n">coroutine</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                        <span class="k">await</span> <span class="n">coroutine</span></div>

<div class="viewcode-block" id="SubsystemModule.update_component_state"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.update_component_state">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_component_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receives and processes incoming component state updates. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># wait for next incoming component state updates</span>
                <span class="n">component_state</span> <span class="p">:</span> <span class="n">ComponentState</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_state_updates</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component state received! Updating subsystem state...&#39;</span><span class="p">)</span>

                <span class="c1"># update component state list</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">component_states</span><span class="p">[</span><span class="n">component_state</span><span class="o">.</span><span class="n">component_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">component_state</span>
                
                <span class="c1"># check for subsystem and component-level critical or failure states</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_subsystem_critical</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_component_critical</span><span class="p">()</span>
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_subsystem_failure</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_component_failure</span><span class="p">()):</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_subsystem_critical</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subsystem is in a subsystem-level critical state!&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_component_critical</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subsystem is in a component-level critical state!&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_subsystem_failure</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subsystem is in a subsystem-level failure state!&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_component_failure</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subsystem is in a component-level failure state!&#39;</span><span class="p">)</span>

                    <span class="c1"># set component health to critical</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">SubsystemHealth</span><span class="o">.</span><span class="n">CRITIAL</span>

                    <span class="c1"># trigger critical state event if it hasn&#39;t been triggered already</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_subsystem_critical</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subsystem state is nominal!&#39;</span><span class="p">)</span>

                    <span class="c1"># set component health to nominal</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">SubsystemHealth</span><span class="o">.</span><span class="n">NOMINAL</span>

                    <span class="c1"># reset critical state event</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span> 

                <span class="c1"># release update lock</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># communicate to other processes that the subsystem&#39;s component states have been updated</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subsystem state has been updated!&#39;</span><span class="p">)</span>

                <span class="c1"># communicate to Command and data handling that the subsystem&#39;s state has been updated</span>
                <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">SubsystemStateMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">SubsystemNames</span><span class="o">.</span><span class="n">CNDH</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Update interrupted!&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="SubsystemModule.update_subsytem_state"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.update_subsytem_state">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_subsytem_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receives state updates from other subsystems and reacts accordingly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">subsystem_state</span> <span class="p">:</span> <span class="n">SubsystemState</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsystem_state_updates</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsystem_state_update_handler</span><span class="p">(</span><span class="n">subsystem_state</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="SubsystemModule.subsystem_state_update_handler"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.subsystem_state_update_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">subsystem_state_update_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subsystem_state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reacts to other subsystem state updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="SubsystemModule.crit_monitor"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.crit_monitor">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">crit_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monitors subsystem state and triggers critical event if a critical state is detected</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">SubsystemHealth</span><span class="o">.</span><span class="n">FAILURE</span><span class="p">:</span>
                    <span class="c1"># if subsystem is in failure state, sleep for the remainder of the simulation</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>
                                
                <span class="c1"># wait for next state update </span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

                <span class="c1"># get latest state and acquire state lock</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">SubsystemHealth</span><span class="o">.</span><span class="n">CRITIAL</span><span class="p">:</span>
                    <span class="c1"># subsystem is in critical state</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="c1"># release state lock</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>
                        
                        <span class="c1"># inform Command and Data Handling subsystem of current subsystem critical state</span>
                        <span class="n">state</span> <span class="p">:</span> <span class="n">SubsystemState</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">SubsystemStateMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">SubsystemNames</span><span class="o">.</span><span class="n">CNDH</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>                          

                        <span class="c1"># trigger critical state event                             </span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">critical</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                
                <span class="c1"># release state lock</span>
                <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="SubsystemModule.is_subsystem_critical"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.is_subsystem_critical">[docs]</a>    <span class="k">def</span> <span class="nf">is_subsystem_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detects subsystem-level critical state using latest component states received by this subsystem</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SubsystemModule.is_component_critical"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.is_component_critical">[docs]</a>    <span class="k">def</span> <span class="nf">is_component_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detects component-level critical state using latest component states received by this subsystem</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">component_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_states</span><span class="p">:</span>
            <span class="n">component_state</span> <span class="p">:</span> <span class="n">ComponentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_states</span><span class="p">[</span><span class="n">component_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">component_state</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">CRITIAL</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SubsystemModule.failure_monitor"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.failure_monitor">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">failure_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monitors subsystem state and triggers failure event if a failure state is detected</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> 
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">SubsystemHealth</span><span class="o">.</span><span class="n">FAILURE</span><span class="p">:</span>
                    <span class="c1"># if subsystem is in failure state, sleep for the rest of the simulation</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># wait for next component update</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

                    <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>   

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">SubsystemHealth</span><span class="o">.</span><span class="n">CRITIAL</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_subsystem_failure</span><span class="p">():</span>
                        <span class="c1"># subsystem is in a potential failure state</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Possible subsystem failure state detected!&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>                            
                            <span class="c1"># failure event has not been triggered yet</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Waiting for CNDH subsytem to revert possible subsystem failure state...&#39;</span><span class="p">)</span>

                            <span class="c1"># release state lock</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                            <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="c1"># give Command and Data Handling subsystem one update cycle to respond to potential failure</span>
                            <span class="n">f_min</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span><span class="p">:</span>
                                <span class="n">component</span> <span class="p">:</span> <span class="n">ComponentModule</span>
                                <span class="k">if</span> <span class="n">component</span><span class="o">.</span><span class="n">UPDATE_FREQUENCY</span> <span class="o">&lt;</span> <span class="n">f_min</span><span class="p">:</span>
                                    <span class="n">f_min</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">UPDATE_FREQUENCY</span>

                            <span class="c1">#await self.sim_wait(1/f_min) TODO readd this!!!</span>

                            <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_subsystem_failure</span><span class="p">():</span>
                                <span class="c1"># subsystem is still in a failure state, triggering failure sequence</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Possible subsystem failure state persisted. Triggering subsystem failure...&#39;</span><span class="p">)</span>

                                <span class="c1"># update subsystem&#39;s health to failure state and disable subsystem</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">SubsystemHealth</span><span class="o">.</span><span class="n">FAILURE</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SubsystemStatus</span><span class="o">.</span><span class="n">OFF</span>
                                
                                <span class="c1"># release state lock</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>      
                                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>                

                                <span class="c1"># disable every component that comprises this subsystem</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Disabling all subsystem components.&#39;</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span><span class="p">:</span>
                                    <span class="n">component</span> <span class="p">:</span> <span class="n">ComponentModule</span>
                                    <span class="k">if</span> <span class="n">component</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Disabling component </span><span class="si">{</span><span class="n">component</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
                                        <span class="n">kill_task</span> <span class="o">=</span> <span class="n">DisableComponentTask</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                        <span class="n">kill_msg</span> <span class="o">=</span> <span class="n">ComponentTaskMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">kill_task</span><span class="p">)</span>
                                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">kill_msg</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component </span><span class="si">{</span><span class="n">component</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> already disabled!&#39;</span><span class="p">)</span>

                                <span class="c1"># wait for every component to turn off</span>
                                <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span><span class="p">:</span>
                                    <span class="n">component</span> <span class="p">:</span> <span class="n">ComponentModule</span>
                                    <span class="k">await</span> <span class="n">component</span><span class="o">.</span><span class="n">disabled</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component </span><span class="si">{</span><span class="n">component</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> successfully disabled!&#39;</span><span class="p">)</span>

                                <span class="c1"># communicate CNDH Subsystem of subsystem failure state</span>
                                <span class="n">state</span> <span class="p">:</span> <span class="n">SubsystemState</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="n">SubsystemStateMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">SubsystemNames</span><span class="o">.</span><span class="n">CNDH</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                                <span class="c1"># trigger failure state</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Failure event triggered.&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Possible subsystem failure state adverted!&#39;</span><span class="p">)</span>
                    
                    <span class="c1"># release state lock</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>
                    

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="SubsystemModule.is_subsystem_failure"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.is_subsystem_failure">[docs]</a>    <span class="k">def</span> <span class="nf">is_subsystem_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detects subsystem-level failure state using latest component states received by this subsystem. </span>
<span class="sd">        By default it fails only if all components are in a failure state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_comp_failure</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span><span class="p">:</span>
            <span class="n">component</span> <span class="p">:</span> <span class="n">ComponentModule</span>
            <span class="k">if</span> <span class="n">component</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">FAILURE</span><span class="p">:</span>
                <span class="n">all_comp_failure</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">all_comp_failure</span></div>

<div class="viewcode-block" id="SubsystemModule.is_component_failure"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.is_component_failure">[docs]</a>    <span class="k">def</span> <span class="nf">is_component_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detects component-level failure state using latest component states received by this subsystem</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">component_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_states</span><span class="p">:</span>
            <span class="n">component_state</span> <span class="p">:</span> <span class="n">ComponentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_states</span><span class="p">[</span><span class="n">component_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">component_state</span><span class="o">.</span><span class="n">health</span> <span class="ow">is</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">FAILURE</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --------------------</span>
<span class="sd">    TASKS AND EVENT HANDLER</span>
<span class="sd">    --------------------</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SubsystemModule.task_processor"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.task_processor">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">task_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes tasks in the order they are received. Listens for any abort commands that may be received during </span>
<span class="sd">        the performance of the task and processes them accordingly. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># wait for the next incoming task</span>
                <span class="n">task</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ComponentTask</span><span class="p">,</span> <span class="n">SubsystemTask</span><span class="p">,</span> <span class="n">PlatformTask</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting task of type: </span><span class="se">\&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">TaskStatus</span><span class="o">.</span><span class="n">IN_PROCESS</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">ACTIONS</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

                <span class="c1"># inform Command and Data Handling subsytem of the current subsystem state</span>
                <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">SubsystemStateMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">SubsystemNames</span><span class="o">.</span><span class="n">CNDH</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

                <span class="c1"># start to perform task</span>
                <span class="n">perform_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">perform_task</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
                <span class="n">listen_for_abort</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listen_for_abort</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
                <span class="n">wait_for_failure</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failure</span><span class="o">.</span><span class="n">wait</span><span class="p">())</span>
                <span class="n">wait_for_disable</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disabled</span><span class="o">.</span><span class="n">wait</span><span class="p">())</span>

                <span class="n">perform_task</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s1">&#39;PerformTask&#39;</span><span class="p">)</span>
                <span class="n">listen_for_abort</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s1">&#39;ListenForAbort&#39;</span><span class="p">)</span>
                <span class="n">wait_for_failure</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s1">&#39;WaitForSubsystemFailure&#39;</span><span class="p">)</span>
                <span class="n">wait_for_disable</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="s1">&#39;WaitForSubsystemDisable&#39;</span><span class="p">)</span>

                <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span><span class="n">perform_task</span><span class="p">,</span> <span class="n">listen_for_abort</span><span class="p">,</span> <span class="n">wait_for_failure</span><span class="p">,</span> <span class="n">wait_for_disable</span><span class="p">]</span>

                <span class="c1"># wait for task completion, abort signal, or subsystem failure/disable event</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">pending_process</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                    <span class="n">pending_process</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span>
                    <span class="k">if</span> <span class="s1">&#39;Wait&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pending_process</span><span class="o">.</span><span class="n">get_name</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Aborting </span><span class="si">{</span><span class="n">pending_process</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
                        <span class="n">pending_process</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                        <span class="k">await</span> <span class="n">pending_process</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pending_process</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s1"> successfully aborted!&#39;</span><span class="p">)</span>

                <span class="c1"># get task completion status</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">perform_task</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task status: </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Informing Command and Data Handling Subsystem of task status...&#39;</span><span class="p">)</span>
                <span class="c1"># inform Command and Data Handling subsystem of the status of completion of component tasks</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">SubsystemTaskCompletionMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">SubsystemNames</span><span class="o">.</span><span class="n">CNDH</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">PlatformTask</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">SubsystemNames</span><span class="o">.</span><span class="n">CNDH</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task status communicated to CNDH subsystem! Informing Planning Module of task status...&#39;</span><span class="p">)</span>
                    <span class="c1"># inform Scheduling Module of the status of completion of platform-level tasks</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">PlatformTaskCompletionMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">AgentModuleTypes</span><span class="o">.</span><span class="n">PLANNING_MODULE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="c1"># inform Command and Data Handling subsytem of the new subsystem state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task status communicated! Informing Command and Data Handling subsystem of subsystem state...&#39;</span><span class="p">)</span>
                <span class="n">state</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">SubsystemStateMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">SubsystemNames</span><span class="o">.</span><span class="n">CNDH</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subsystem state communicated! Finished processing task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>

                <span class="c1"># log task completion status</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">ACTIONS</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
                <span class="n">process</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span>
                <span class="n">process</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">process</span></div>

<div class="viewcode-block" id="SubsystemModule.listen_for_abort"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.listen_for_abort">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">listen_for_abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PlatformTask</span><span class="p">,</span> <span class="n">SubsystemTask</span><span class="p">,</span> <span class="n">ComponentTask</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Listens for any abort command targetted towards the task being performed.</span>
<span class="sd">        Any aborts targetted to other tasks are ignored but not discarded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">other_aborts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">abort_task</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">aborts</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">abort_task</span> <span class="o">==</span> <span class="n">task</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">abort</span> <span class="ow">in</span> <span class="n">other_aborts</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">aborts</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">abort</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">other_aborts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">abort_task</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">abort</span> <span class="ow">in</span> <span class="n">other_aborts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aborts</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">abort</span><span class="p">)</span></div>

<div class="viewcode-block" id="SubsystemModule.perform_task"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.perform_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">perform_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PlatformTask</span><span class="p">,</span> <span class="n">SubsystemTask</span><span class="p">,</span> <span class="n">ComponentTask</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">TaskStatus</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a task given to this subsystem. If the task is a subsystem-level task, it decomposes the task into a list of component tasks to be performed.</span>
<span class="sd">        Rejects any tasks if the subsystem is in a failure mode of if it is not intended for to be performed by this subsystem. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
            
            <span class="c1"># Decompose subsytem task into component tasks</span>
            <span class="n">task_handler</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">PlatformTask</span><span class="p">):</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">decompose_platform_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">SubsystemTask</span><span class="p">):</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">decompose_subsystem_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ComponentTask</span><span class="p">):</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> not supported.&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Decomposed task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> into a set of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span><span class="si">}</span><span class="s1"> subtasks.&#39;</span><span class="p">)</span>

            <span class="c1"># submit component tasks</span>
            <span class="k">for</span> <span class="n">task_i</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
                <span class="n">task_handler</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_handler</span><span class="p">(</span><span class="n">task_i</span><span class="p">))</span>

                <span class="k">await</span> <span class="n">task_handler</span>

                <span class="n">task_status</span> <span class="o">=</span> <span class="n">task_handler</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">task_status</span> <span class="ow">is</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">ABORTED</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subtask of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task_i</span><span class="p">)</span><span class="si">}</span><span class="s1"> was aborted.&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

                <span class="k">elif</span> <span class="n">task_status</span> <span class="ow">is</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">DONE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Subtask of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task_i</span><span class="p">)</span><span class="si">}</span><span class="s1"> successfully completed!&#39;</span><span class="p">)</span>
            
            <span class="c1"># return task completion status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> successfully completed!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">DONE</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="c1"># cancel task_handler</span>
            <span class="k">if</span> <span class="n">task_handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_handler</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="n">task_handler</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">task_handler</span>

            <span class="c1"># return task abort status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> was aborted.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">ABORTED</span></div>

<div class="viewcode-block" id="SubsystemModule.decompose_platform_task"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.decompose_platform_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">decompose_platform_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span> <span class="p">:</span> <span class="n">PlatformTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decomposes a platform-level task and returns a list of subsystem-level tasks to be performed by this or other subsystems.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Module does not support platform-level tasks.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="SubsystemModule.decompose_subsystem_task"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.decompose_subsystem_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">decompose_subsystem_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span> <span class="p">:</span> <span class="n">SubsystemTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decomposes a subsystem-level task and returns a list of component-level tasks to be performed by this subsystem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Module does not support subsystem-level tasks.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="SubsystemModule.task_handler"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.task_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">task_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">SubsystemTask</span><span class="p">,</span> <span class="n">ComponentTask</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles component tasks to be performed by this subsystem&#39;s components or subsystem tasks intended for other subsystems.</span>
<span class="sd">        Will abort any subsystem task submitted to itself to avoid locking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ComponentTask</span><span class="p">):</span>
                <span class="n">component_found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span><span class="p">:</span>
                    <span class="n">component</span> <span class="p">:</span> <span class="n">ComponentModule</span>
                    <span class="k">if</span> <span class="n">component</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">task</span><span class="o">.</span><span class="n">component</span><span class="p">:</span>
                        <span class="n">component_found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">component_found</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component task intended for another subsystem. Initially intended for component </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

                <span class="c1"># submit task to be performed by component</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Submitting component task to </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">...&#39;</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">ComponentTaskMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">component</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">SubsystemTask</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">subsystem</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="c1"># Cannot submit a task to itself while performing other tasks. Will lead to blocking.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attempting to submit a subsystem task intended for self.&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

                <span class="c1"># submit task to be performed by subsystem</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Submitting subsystem task to </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">subsystem</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">...&#39;</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">SubsystemTaskMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">subsystem</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># wait for response</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Waiting for task completion status response...&#39;</span><span class="p">)</span>
            <span class="n">status</span> <span class="p">:</span> <span class="n">TaskStatus</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">resp</span> <span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">resp_task</span><span class="p">,</span> <span class="n">resp_status</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">recevied_task_status</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">resp_task</span> <span class="o">==</span> <span class="n">task</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">resp_status</span>              
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Completion status for target task received! Status for task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received a task completion status for another task. Waiting for task completion status response...&#39;</span><span class="p">)</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">resp_task</span><span class="p">,</span> <span class="n">resp_status</span><span class="p">)</span> <span class="p">)</span>

            <span class="k">for</span> <span class="n">resp_task</span><span class="p">,</span> <span class="n">resp_status</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">recevied_task_status</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">(</span><span class="n">resp_task</span><span class="p">,</span> <span class="n">resp_status</span><span class="p">)</span> <span class="p">)</span>

            <span class="k">return</span> <span class="n">status</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">ABORTED</span></div>

<div class="viewcode-block" id="SubsystemModule.environment_event_processor"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.environment_event_processor">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">environment_event_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes any incoming events from the environment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">aquired</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># wait for an event to be received</span>
                <span class="n">event_broadcast</span> <span class="p">:</span> <span class="n">EventBroadcastMessage</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_events</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

                <span class="c1"># handle according to event type</span>
                <span class="n">aquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

                <span class="c1"># record subsystem-level effects</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_event_handler</span><span class="p">(</span><span class="n">event_broadcast</span><span class="p">)</span>

                <span class="c1"># release state lock</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="n">aquired</span> <span class="o">=</span> <span class="kc">False</span>       

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">aquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="SubsystemModule.environment_event_handler"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.environment_event_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">environment_event_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_broadcast</span> <span class="p">:</span> <span class="n">EnvironmentBroadcastMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Affects the component depending on the type of event being received. Forwards all events</span>
<span class="sd">        to all of this subsystem&#39;s components by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span><span class="p">:</span>
            <span class="n">component</span> <span class="p">:</span> <span class="n">ComponentModule</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">InternalMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">event_broadcast</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    --------------------</span>
<span class="sd">    HELPING FUNCTIONS</span>
<span class="sd">    --------------------</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SubsystemModule.get_state"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemModule.get_state">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a state class object capturing the state of this subsystem</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># process indicators</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># wait for any possible update process to finish</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="c1"># get state object from component status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subsystem_state</span> <span class="p">:</span> <span class="n">SubsystemState</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsystem_state</span><span class="o">.</span><span class="n">from_subsystem</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="c1"># release update lock</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">state</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">locked</span><span class="p">()</span> <span class="ow">and</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="c1"># if this process had acquired the update_lock and has not released it, then release</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span></div></div>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">-------------------------------</span>
<span class="sd">COMPONENT AND SUBSYSTEM STATES</span>
<span class="sd">-------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="ComponentState"><a class="viewcode-back" href="../engineering.html#engineering.ComponentState">[docs]</a><span class="k">class</span> <span class="nc">ComponentState</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">component_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="n">power_consumed</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">power_supplied</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span><span class="p">,</span> <span class="n">status</span> <span class="p">:</span> <span class="n">ComponentStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describes the state of a generic component. Each component type must have its own component state class if it contains any</span>
<span class="sd">        extra metrics that describe its state besides power consumed, power supplied, health, and operational status. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># component info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">component_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">component_type</span> <span class="o">=</span> <span class="n">component_type</span>

        <span class="c1"># power state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_consumed</span> <span class="o">=</span> <span class="n">power_consumed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_supplied</span> <span class="o">=</span> <span class="n">power_supplied</span>

        <span class="c1"># component status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">health</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>

<div class="viewcode-block" id="ComponentState.from_component"><a class="viewcode-back" href="../engineering.html#engineering.ComponentState.from_component">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">from_component</span><span class="p">(</span><span class="n">component</span> <span class="p">:</span> <span class="n">ComponentModule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a component state object from a component module object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ComponentState.to_dict"><a class="viewcode-back" href="../engineering.html#engineering.ComponentState.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ComponentState&#39;</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_name</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;power_consumed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_consumed</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;power_supplied&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_supplied</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;health&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">name</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">name</span>

        <span class="k">return</span> <span class="n">out</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span></div>

<div class="viewcode-block" id="SubsystemState"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemState">[docs]</a><span class="k">class</span> <span class="nc">SubsystemState</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subsystem_type</span> <span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="n">component_states</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">health</span> <span class="p">:</span> <span class="n">SubsystemHealth</span><span class="p">,</span> <span class="n">status</span> <span class="p">:</span> <span class="n">SubsystemStatus</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describes the state of a generic subsystem. Each subsystem type must have its own component state class if it contains any</span>
<span class="sd">        extra metrics that describe its state besides health, operational status, and subcomponent states. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># subsystem info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsystem_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsystem_type</span> <span class="o">=</span> <span class="n">subsystem_type</span>

        <span class="c1"># subsystem status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">health</span> <span class="o">=</span> <span class="n">health</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>

        <span class="c1"># component states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">component_states</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">component_states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">component_states</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="n">component_states</span><span class="p">[</span><span class="n">component</span><span class="p">]</span>

<div class="viewcode-block" id="SubsystemState.from_subsystem"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemState.from_subsystem">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">from_subsystem</span><span class="p">(</span><span class="n">subsystem</span> <span class="p">:</span> <span class="n">SubsystemModule</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="SubsystemState.to_dict"><a class="viewcode-back" href="../engineering.html#engineering.SubsystemState.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SubsystemState&#39;</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsystem_name</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;health&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">name</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">name</span>

        <span class="n">component_states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_states</span><span class="p">:</span>
            <span class="n">state</span> <span class="p">:</span> <span class="n">ComponentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_states</span><span class="p">[</span><span class="n">component</span><span class="p">]</span>
            <span class="n">component_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;component_states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">component_states</span>

        <span class="k">return</span> <span class="n">out</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">COMMAND AND DATA HANDLING SUBSYSTEM</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="CommandAndDataHandlingSubsystem"><a class="viewcode-back" href="../engineering.html#engineering.CommandAndDataHandlingSubsystem">[docs]</a><span class="k">class</span> <span class="nc">CommandAndDataHandlingSubsystem</span><span class="p">(</span><span class="n">SubsystemModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">parent_platform_sim</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> 
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">SubsystemNames</span><span class="o">.</span><span class="n">CNDH</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_platform_sim</span><span class="p">,</span> <span class="n">CommandAndDataHandlingState</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span> <span class="n">OnboardComputerModule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1e9</span><span class="p">)</span> <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subsystem_states</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    
<div class="viewcode-block" id="CommandAndDataHandlingSubsystem.subsystem_state_update_handler"><a class="viewcode-back" href="../engineering.html#engineering.CommandAndDataHandlingSubsystem.subsystem_state_update_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">subsystem_state_update_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subsystem_state</span> <span class="p">:</span> <span class="n">SubsystemState</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reacts to other subsystem state updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update subsystem state tracking dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsystem_states</span><span class="p">[</span><span class="n">subsystem_state</span><span class="o">.</span><span class="n">subsystem_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">subsystem_state</span>
        
        <span class="c1"># log system state</span>
        <span class="n">parent_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span>

        <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SystemState&#39;</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_agent</span><span class="o">.</span><span class="n">name</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;health&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">health</span><span class="o">.</span><span class="n">name</span>
                
        <span class="n">subsystem_states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">subsystem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsystem_states</span><span class="p">:</span>
            <span class="n">state</span> <span class="p">:</span> <span class="n">SubsystemState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsystem_states</span><span class="p">[</span><span class="n">subsystem</span><span class="p">]</span>
            <span class="n">subsystem_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;subsystem_states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subsystem_states</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">STATE</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span></div>


<div class="viewcode-block" id="CommandAndDataHandlingSubsystem.decompose_platform_task"><a class="viewcode-back" href="../engineering.html#engineering.CommandAndDataHandlingSubsystem.decompose_platform_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">decompose_platform_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span> <span class="p">:</span> <span class="n">PlatformTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decomposes a platform-level task and returns a list of subsystem-level tasks to be performed by this or other subsystems.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ObservationTask</span><span class="p">):</span>
            <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">target</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Decompose observation platform-level task into subsystem-level tasks&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received observation task!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span> <span class="n">PerformMeasurement</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">instrument_list</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">durations</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">obs_info</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ManeuverTask</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received maneuver task!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span> <span class="n">task</span><span class="o">.</span><span class="n">maneuver_task</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">decompose_platform_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="CommandAndDataHandlingState"><a class="viewcode-back" href="../engineering.html#engineering.CommandAndDataHandlingState">[docs]</a><span class="k">class</span> <span class="nc">CommandAndDataHandlingState</span><span class="p">(</span><span class="n">SubsystemState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">component_states</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
                <span class="n">health</span><span class="p">:</span> <span class="n">SubsystemHealth</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">SubsystemStatus</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">SubsystemNames</span><span class="o">.</span><span class="n">CNDH</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">CommandAndDataHandlingSubsystem</span><span class="p">,</span> <span class="n">component_states</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">from_subsystem</span><span class="p">(</span><span class="n">cndh</span><span class="p">:</span> <span class="n">CommandAndDataHandlingSubsystem</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CommandAndDataHandlingState</span><span class="p">(</span><span class="n">cndh</span><span class="o">.</span><span class="n">component_states</span><span class="p">,</span> <span class="n">cndh</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">cndh</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

<div class="viewcode-block" id="CommandAndDataHandlingState.from_subsystem"><a class="viewcode-back" href="../engineering.html#engineering.CommandAndDataHandlingState.from_subsystem">[docs]</a>    <span class="k">def</span> <span class="nf">from_subsystem</span><span class="p">(</span><span class="n">cndh</span><span class="p">:</span> <span class="n">CommandAndDataHandlingSubsystem</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CommandAndDataHandlingState</span><span class="p">(</span><span class="n">cndh</span><span class="o">.</span><span class="n">component_states</span><span class="p">,</span> <span class="n">cndh</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">cndh</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="OnboardComputerModule"><a class="viewcode-back" href="../engineering.html#engineering.OnboardComputerModule">[docs]</a><span class="k">class</span> <span class="nc">OnboardComputerModule</span><span class="p">(</span><span class="n">ComponentModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">parent_subsystem</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> 
                <span class="n">average_power_consumption</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">memory_capacity</span> <span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">,</span> 
                <span class="n">f_update</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">ONBOARD_COMPUTER</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_subsystem</span><span class="p">,</span> <span class="n">OnboardComputerState</span><span class="p">,</span> <span class="n">average_power_consumption</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">f_update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_stored</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_capacity</span> <span class="o">=</span> <span class="n">memory_capacity</span>

<div class="viewcode-block" id="OnboardComputerModule.is_critical"><a class="viewcode-back" href="../engineering.html#engineering.OnboardComputerModule.is_critical">[docs]</a>    <span class="k">def</span> <span class="nf">is_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns true if the current state of the component is critical. </span>
<span class="sd">        Is true when the memory has reached 80% of its capacity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.90</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_stored</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_capacity</span> <span class="o">*</span> <span class="n">threshold</span></div>

<div class="viewcode-block" id="OnboardComputerModule.is_failed"><a class="viewcode-back" href="../engineering.html#engineering.OnboardComputerModule.is_failed">[docs]</a>    <span class="k">def</span> <span class="nf">is_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns true if the current state of the component is a failure state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_failed</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_stored</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_capacity</span></div>

<div class="viewcode-block" id="OnboardComputerModule.perform_task"><a class="viewcode-back" href="../engineering.html#engineering.OnboardComputerModule.perform_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">perform_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">ComponentTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskStatus</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a task given to this component. </span>
<span class="sd">        Rejects any tasks if the component is in a failure mode of if it is not intended for to be performed by this component. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># check if component was the intended performer of this task</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">component</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component task not intended for this component. Initially intended for component </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">. Aborting task...&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">SaveToMemoryTask</span><span class="p">):</span>
                <span class="c1">#await self.enabled.set() TODO fix this enable setting?</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()</span>
                <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_target</span><span class="p">()</span>
                <span class="n">data_vol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">DeleteFromMemoryTask</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_stored</span> <span class="o">-</span> <span class="n">data_vol</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># insufficient data to be deleted, discarding task.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Module does NOT contain data to delete. Data size: </span><span class="si">{</span><span class="n">data_vol</span><span class="si">}</span><span class="s1">, memory state: (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_stored</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_capacity</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># data successfully stored in internal memory, send to science module for processing</span>
                        
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">DataDeletedMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">AgentModuleTypes</span><span class="o">.</span><span class="n">SCIENCE_MODULE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Deleting data from </span><span class="si">{</span><span class="n">AgentModuleTypes</span><span class="o">.</span><span class="n">SCIENCE_MODULE</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">memory_stored</span> <span class="o">-=</span> <span class="n">data_vol</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data successfully deleted from internal memory! New internal memory state: (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_stored</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_capacity</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_stored</span> <span class="o">+</span> <span class="n">data_vol</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_capacity</span><span class="p">:</span>
                        <span class="c1"># insufficient memory storage for incoming data, discarding task.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Module does NOT contain enough memory space to store data. Data size: </span><span class="si">{</span><span class="n">data_vol</span><span class="si">}</span><span class="s1">, memory state: (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_stored</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_capacity</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># data successfully stored in internal memory, send to science module for processing</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">DataMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">AgentModuleTypes</span><span class="o">.</span><span class="n">SCIENCE_MODULE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sending data to </span><span class="si">{</span><span class="n">AgentModuleTypes</span><span class="o">.</span><span class="n">SCIENCE_MODULE</span><span class="si">}</span><span class="s1"> for processing...&#39;</span><span class="p">)</span>
                        
                        <span class="bp">self</span><span class="o">.</span><span class="n">memory_stored</span> <span class="o">+=</span> <span class="n">data_vol</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data successfully stored in internal memory! New internal memory state: (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_stored</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_capacity</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
                        
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">DONE</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported.&#39;</span><span class="p">)</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span> 
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Aborting task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

            <span class="c1"># release update lock if cancelled during task handling</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="c1"># return task abort status</span>
            <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">ABORTED</span></div></div>

<div class="viewcode-block" id="OnboardComputerState"><a class="viewcode-back" href="../engineering.html#engineering.OnboardComputerState">[docs]</a><span class="k">class</span> <span class="nc">OnboardComputerState</span><span class="p">(</span><span class="n">ComponentState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                <span class="n">component_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> 
                <span class="n">power_consumed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">power_supplied</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">memory_stored</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">memory_capacity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">component_type</span><span class="p">,</span> <span class="n">power_consumed</span><span class="p">,</span> <span class="n">power_supplied</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmemory_stored</span> <span class="o">=</span> <span class="n">memory_stored</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_capacity</span> <span class="o">=</span> <span class="n">memory_capacity</span>

<div class="viewcode-block" id="OnboardComputerState.from_component"><a class="viewcode-back" href="../engineering.html#engineering.OnboardComputerState.from_component">[docs]</a>    <span class="k">def</span> <span class="nf">from_component</span><span class="p">(</span><span class="n">component</span><span class="p">:</span> <span class="n">OnboardComputerModule</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OnboardComputerState</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> 
                                    <span class="n">OnboardComputerModule</span><span class="p">,</span> 
                                    <span class="n">component</span><span class="o">.</span><span class="n">power_consumed</span><span class="p">,</span> 
                                    <span class="n">component</span><span class="o">.</span><span class="n">power_supplied</span><span class="p">,</span> 
                                    <span class="n">component</span><span class="o">.</span><span class="n">memory_stored</span><span class="p">,</span> 
                                    <span class="n">component</span><span class="o">.</span><span class="n">memory_capacity</span><span class="p">,</span> 
                                    <span class="n">component</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> 
                                    <span class="n">component</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">GNC SUBSYSTEM</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="GuidanceAndNavigationSubsystem"><a class="viewcode-back" href="../engineering.html#engineering.GuidanceAndNavigationSubsystem">[docs]</a><span class="k">class</span> <span class="nc">GuidanceAndNavigationSubsystem</span><span class="p">(</span><span class="n">SubsystemModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">parent_platform_sim</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> 
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">SubsystemNames</span><span class="o">.</span><span class="n">GNC</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">parent_platform_sim</span><span class="p">,</span> <span class="n">GuidanceAndNavigationSubsystemState</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">PositionDeterminationModule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                            <span class="n">SunSensorModule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                          <span class="p">]</span></div>

<div class="viewcode-block" id="GuidanceAndNavigationSubsystemState"><a class="viewcode-back" href="../engineering.html#engineering.GuidanceAndNavigationSubsystemState">[docs]</a><span class="k">class</span> <span class="nc">GuidanceAndNavigationSubsystemState</span><span class="p">(</span><span class="n">SubsystemState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_states</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">health</span><span class="p">:</span> <span class="n">SubsystemHealth</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">SubsystemStatus</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">SubsystemNames</span><span class="o">.</span><span class="n">GNC</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">GuidanceAndNavigationSubsystem</span><span class="p">,</span> <span class="n">component_states</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
    
<div class="viewcode-block" id="GuidanceAndNavigationSubsystemState.from_subsystem"><a class="viewcode-back" href="../engineering.html#engineering.GuidanceAndNavigationSubsystemState.from_subsystem">[docs]</a>    <span class="k">def</span> <span class="nf">from_subsystem</span><span class="p">(</span><span class="n">gnc</span><span class="p">:</span> <span class="n">GuidanceAndNavigationSubsystem</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">GuidanceAndNavigationSubsystemState</span><span class="p">(</span><span class="n">gnc</span><span class="o">.</span><span class="n">component_states</span><span class="p">,</span> <span class="n">gnc</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">gnc</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="PositionDeterminationModule"><a class="viewcode-back" href="../engineering.html#engineering.PositionDeterminationModule">[docs]</a><span class="k">class</span> <span class="nc">PositionDeterminationModule</span><span class="p">(</span><span class="n">ComponentModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">parent_subsystem</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> 
                <span class="n">average_power_consumption</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">,</span> 
                <span class="n">f_update</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">POS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_subsystem</span><span class="p">,</span> <span class="n">PositionDeterminationState</span><span class="p">,</span> <span class="n">average_power_consumption</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">f_update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vel</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

<div class="viewcode-block" id="PositionDeterminationModule.update_properties"><a class="viewcode-back" href="../engineering.html#engineering.PositionDeterminationModule.update_properties">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update_properties</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># sense linear position and velocity vectors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sensing agent position and velocity from environment...&#39;</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">AgentSenseMessage</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_environment_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span> <span class="p">:</span> <span class="n">AgentSenseMessage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Current state: pos=[</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">pos</span><span class="si">}</span><span class="s1">], vel=[</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">vel</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x_i</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">pos</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_i</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">vel</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">v_i</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">vel</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_i</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="PositionDeterminationState"><a class="viewcode-back" href="../engineering.html#engineering.PositionDeterminationState">[docs]</a><span class="k">class</span> <span class="nc">PositionDeterminationState</span><span class="p">(</span><span class="n">ComponentState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">power_consumed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">power_supplied</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">pos</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                <span class="n">vel</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">POS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">PositionDeterminationModule</span><span class="p">,</span> <span class="n">power_consumed</span><span class="p">,</span> <span class="n">power_supplied</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x_i</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_i</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vel</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v_i</span> <span class="ow">in</span> <span class="n">vel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_i</span><span class="p">)</span>

<div class="viewcode-block" id="PositionDeterminationState.from_component"><a class="viewcode-back" href="../engineering.html#engineering.PositionDeterminationState.from_component">[docs]</a>    <span class="k">def</span> <span class="nf">from_component</span><span class="p">(</span><span class="n">component</span><span class="p">:</span> <span class="n">PositionDeterminationModule</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PositionDeterminationState</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">power_consumed</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">power_supplied</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">vel</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="SunSensorModule"><a class="viewcode-back" href="../engineering.html#engineering.SunSensorModule">[docs]</a><span class="k">class</span> <span class="nc">SunSensorModule</span><span class="p">(</span><span class="n">ComponentModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">parent_subsystem</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> 
                <span class="n">average_power_consumption</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">,</span> 
                <span class="n">f_update</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">SUN_SENSOR</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_subsystem</span><span class="p">,</span> <span class="n">SunSensorState</span><span class="p">,</span> <span class="n">average_power_consumption</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">f_update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eclipse</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sun_vector</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

<div class="viewcode-block" id="SunSensorModule.update_properties"><a class="viewcode-back" href="../engineering.html#engineering.SunSensorModule.update_properties">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update_properties</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># sense eclipse state and sun-vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sensing eclipse state from environment...&#39;</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">AgentSenseMessage</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_environment_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span> <span class="p">:</span> <span class="n">AgentSenseMessage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Current state: eclpise=</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">eclipse</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eclipse</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">eclipse</span></div></div>
            <span class="c1">#TODO add sun-vector to response output</span>

<div class="viewcode-block" id="SunSensorState"><a class="viewcode-back" href="../engineering.html#engineering.SunSensorState">[docs]</a><span class="k">class</span> <span class="nc">SunSensorState</span><span class="p">(</span><span class="n">ComponentState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">power_consumed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">power_supplied</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">eclipse</span> <span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="n">sun_vector</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">SUN_SENSOR</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">SunSensorModule</span><span class="p">,</span> <span class="n">power_consumed</span><span class="p">,</span> <span class="n">power_supplied</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eclipse</span> <span class="o">=</span> <span class="n">eclipse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sun_vector</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x_i</span> <span class="ow">in</span> <span class="n">sun_vector</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sun_vector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_i</span><span class="p">)</span>

<div class="viewcode-block" id="SunSensorState.from_component"><a class="viewcode-back" href="../engineering.html#engineering.SunSensorState.from_component">[docs]</a>    <span class="k">def</span> <span class="nf">from_component</span><span class="p">(</span><span class="n">component</span><span class="p">:</span> <span class="n">SunSensorModule</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SunSensorState</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">power_consumed</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">power_supplied</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">eclipse</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">sun_vector</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">PAYLOAD SUBSYSTEM</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="PayloadSubsystem"><a class="viewcode-back" href="../engineering.html#engineering.PayloadSubsystem">[docs]</a><span class="k">class</span> <span class="nc">PayloadSubsystem</span><span class="p">(</span><span class="n">SubsystemModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_platform_sim</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">OFF</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">SubsystemNames</span><span class="o">.</span><span class="n">PAYLOAD</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_platform_sim</span><span class="p">,</span> <span class="n">PayloadState</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span> <span class="n">InstrumentComponent</span><span class="p">(</span><span class="n">InstrumentNames</span><span class="o">.</span><span class="n">TEST</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="p">]</span>

<div class="viewcode-block" id="PayloadSubsystem.activate"><a class="viewcode-back" href="../engineering.html#engineering.PayloadSubsystem.activate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">attitude_state</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span></div>

<div class="viewcode-block" id="PayloadSubsystem.subsystem_state_update_handler"><a class="viewcode-back" href="../engineering.html#engineering.PayloadSubsystem.subsystem_state_update_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">subsystem_state_update_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subsystem_state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reacts to other subsystem state updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subsystem_state</span><span class="p">,</span> <span class="n">AttitudeDeterminationAndControlState</span><span class="p">):</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">attitude_state</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">subsystem_state</span><span class="p">)</span></div>

<div class="viewcode-block" id="PayloadSubsystem.decompose_subsystem_task"><a class="viewcode-back" href="../engineering.html#engineering.PayloadSubsystem.decompose_subsystem_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">decompose_subsystem_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span> <span class="p">:</span> <span class="n">SubsystemTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decomposes a subsystem-level task and returns a list of component-level tasks to be performed by this subsystem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">PerformMeasurement</span><span class="p">):</span>
            <span class="n">comp_tasks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># ask for latest attitude state</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">SubsystemStateRequestMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">SubsystemNames</span><span class="o">.</span><span class="n">ADCS</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">attitude_state</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">attitude_state</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">comp_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EnableComponentTask</span><span class="p">(</span><span class="n">InstrumentNames</span><span class="o">.</span><span class="n">TEST</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
            <span class="c1"># instruct each instrument in the observation task to perform the masurement </span>
            <span class="k">for</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">instruments</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">instruments</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span>
                <span class="n">target_lat</span><span class="p">,</span> <span class="n">target_lon</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">target</span>
                <span class="n">comp_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">MeasurementTask</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">durations</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">target_lat</span><span class="p">,</span> <span class="n">target_lon</span><span class="p">,</span> <span class="n">attitude_state</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">comp_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DisableComponentTask</span><span class="p">(</span><span class="n">InstrumentNames</span><span class="o">.</span><span class="n">TEST</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">comp_tasks</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">decompose_subsystem_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="PayloadState"><a class="viewcode-back" href="../engineering.html#engineering.PayloadState">[docs]</a><span class="k">class</span> <span class="nc">PayloadState</span><span class="p">(</span><span class="n">SubsystemState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_states</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">health</span><span class="p">:</span> <span class="n">SubsystemHealth</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">SubsystemStatus</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">SubsystemNames</span><span class="o">.</span><span class="n">PAYLOAD</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">PayloadSubsystem</span><span class="p">,</span> <span class="n">component_states</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>

<div class="viewcode-block" id="PayloadState.from_subsystem"><a class="viewcode-back" href="../engineering.html#engineering.PayloadState.from_subsystem">[docs]</a>    <span class="k">def</span> <span class="nf">from_subsystem</span><span class="p">(</span><span class="n">payload</span><span class="p">:</span> <span class="n">PayloadSubsystem</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PayloadState</span><span class="p">(</span><span class="n">payload</span><span class="o">.</span><span class="n">component_states</span><span class="p">,</span> <span class="n">payload</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">payload</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="InstrumentComponent"><a class="viewcode-back" href="../engineering.html#engineering.InstrumentComponent">[docs]</a><span class="k">class</span> <span class="nc">InstrumentComponent</span><span class="p">(</span><span class="n">ComponentModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                <span class="n">parent_subsystem</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span>  
                <span class="n">average_power_consumption</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">data_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">buffer_capacity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">OFF</span><span class="p">,</span> 
                <span class="n">f_update</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
                <span class="n">n_timed_coroutines</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent_subsystem</span><span class="p">,</span> <span class="n">InstrumentState</span><span class="p">,</span> <span class="n">average_power_consumption</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">f_update</span><span class="p">,</span> <span class="n">n_timed_coroutines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_rate</span> <span class="o">=</span> <span class="n">data_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">=</span> <span class="n">buffer_capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="InstrumentComponent.is_critical"><a class="viewcode-back" href="../engineering.html#engineering.InstrumentComponent.is_critical">[docs]</a>    <span class="k">def</span> <span class="nf">is_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">buffer_capacity_threshold</span> <span class="o">=</span> <span class="mf">0.90</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_critical</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">&gt;=</span> <span class="n">buffer_capacity_threshold</span></div>

<div class="viewcode-block" id="InstrumentComponent.is_failed"><a class="viewcode-back" href="../engineering.html#engineering.InstrumentComponent.is_failed">[docs]</a>    <span class="k">def</span> <span class="nf">is_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_failed</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">&gt;=</span> <span class="mf">1.0</span></div>

<div class="viewcode-block" id="InstrumentComponent.wait_for_failure"><a class="viewcode-back" href="../engineering.html#engineering.InstrumentComponent.wait_for_failure">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># estimate when buffer will be full</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rate</span>

                <span class="c1"># wait for buffer to be full </span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># if instrument is disabled, then it will never fail</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="InstrumentComponent.perform_task"><a class="viewcode-back" href="../engineering.html#engineering.InstrumentComponent.perform_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">perform_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span> <span class="p">:</span> <span class="n">ComponentTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskStatus</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles tasks to be performed by this battery component. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># check if component was the intended performer of this task</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">component</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component task not intended for this component. Initially intended for component </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">. Aborting task...&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">MeasurementTask</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">OFF</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot perform measurement while component status is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>
                
                <span class="c1"># sense environment</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Performing measurement...&#39;</span><span class="p">)</span>
                <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span>
                <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">target</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">ObservationSenseMessage</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="s2">&quot;radiances&quot;</span><span class="p">)</span> <span class="c1"># TODO replace hardcoded radiances with instrument specific measurements</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_environment_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
                <span class="c1"># wait for measurement duration</span>
                <span class="c1"># TODO consider real-time delays from environment server querying for the data being sensed</span>
                <span class="c1"># await self.sim_wait(task.duration) TODO not sure if we want to block off the agent from doing things</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Measurement complete! Sending data to internal memory.&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                <span class="c1"># package data and send to memory</span>
                <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">response</span> <span class="p">:</span> <span class="n">ObservationSenseMessage</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">obs_metadata</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_time</span><span class="p">()</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">obs_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
                    <span class="n">data_save_task</span> <span class="o">=</span> <span class="n">SaveToMemoryTask</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">obs_metadata</span><span class="p">)</span>
                    <span class="n">data_msg</span> <span class="o">=</span> <span class="n">ComponentTaskMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ComponentNames</span><span class="o">.</span><span class="n">ONBOARD_COMPUTER</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data_save_task</span><span class="p">)</span>

                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">data_msg</span><span class="p">)</span>

                <span class="c1"># update state</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

                <span class="c1"># obtain state lock</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

                <span class="c1"># delete data from buffer</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rate</span> <span class="o">*</span> <span class="n">task</span><span class="o">.</span><span class="n">duration</span>

                <span class="c1"># release state lock</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">DONE</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported.&#39;</span><span class="p">)</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span> 
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Aborting task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

            <span class="c1"># release update lock if cancelled during task handling</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="c1"># return task abort status</span>
            <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">ABORTED</span></div>

<div class="viewcode-block" id="InstrumentComponent.update_properties"><a class="viewcode-back" href="../engineering.html#engineering.InstrumentComponent.update_properties">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update_properties</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="c1"># if component is on and receiving sufficient power, then it collects data in its buffer</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rate</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">+=</span> <span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_rate</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span></div></div>

<div class="viewcode-block" id="InstrumentState"><a class="viewcode-back" href="../engineering.html#engineering.InstrumentState">[docs]</a><span class="k">class</span> <span class="nc">InstrumentState</span><span class="p">(</span><span class="n">ComponentState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                <span class="n">power_consumed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">power_supplied</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">data_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">buffer_capacity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">buffer_allocated</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">InstrumentComponent</span><span class="p">,</span> <span class="n">power_consumed</span><span class="p">,</span> <span class="n">power_supplied</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_rate</span> <span class="o">=</span> <span class="n">data_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">=</span> <span class="n">buffer_capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="n">buffer_allocated</span>

<div class="viewcode-block" id="InstrumentState.from_component"><a class="viewcode-back" href="../engineering.html#engineering.InstrumentState.from_component">[docs]</a>    <span class="k">def</span> <span class="nf">from_component</span><span class="p">(</span><span class="n">instrument</span> <span class="p">:</span> <span class="n">InstrumentComponent</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">InstrumentState</span><span class="p">(</span><span class="n">instrument</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">instrument</span><span class="o">.</span><span class="n">power_consumed</span><span class="p">,</span> <span class="n">instrument</span><span class="o">.</span><span class="n">power_supplied</span><span class="p">,</span> <span class="n">instrument</span><span class="o">.</span><span class="n">data_rate</span><span class="p">,</span> <span class="n">instrument</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="p">,</span> <span class="n">instrument</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="p">,</span> <span class="n">instrument</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">instrument</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ADCS </span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="AttitudeDeterminationAndControlSubsystem"><a class="viewcode-back" href="../engineering.html#engineering.AttitudeDeterminationAndControlSubsystem">[docs]</a><span class="k">class</span> <span class="nc">AttitudeDeterminationAndControlSubsystem</span><span class="p">(</span><span class="n">SubsystemModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">parent_platform_sim</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> 
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">SubsystemNames</span><span class="o">.</span><span class="n">ADCS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_platform_sim</span><span class="p">,</span> <span class="n">AttitudeDeterminationAndControlState</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">InertialMeasurementUnitModule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">ReactionWheelModule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                          <span class="p">]</span>

<div class="viewcode-block" id="AttitudeDeterminationAndControlSubsystem.decompose_subsystem_task"><a class="viewcode-back" href="../engineering.html#engineering.AttitudeDeterminationAndControlSubsystem.decompose_subsystem_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">decompose_subsystem_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span> <span class="p">:</span> <span class="n">SubsystemTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decomposes a subsystem-level task and returns a list of component-level tasks to be performed by this subsystem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">PerformAttitudeManeuverTask</span><span class="p">):</span>
            <span class="n">comp_tasks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">comp_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EnableComponentTask</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">REACTION_WHEELS</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
            <span class="n">comp_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AttitudeManeuverTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">maneuver_time</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">target_angular_pos</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">target_angular_vel</span><span class="p">))</span>
            <span class="n">comp_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DisableComponentTask</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">REACTION_WHEELS</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">comp_tasks</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">decompose_subsystem_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="AttitudeDeterminationAndControlState"><a class="viewcode-back" href="../engineering.html#engineering.AttitudeDeterminationAndControlState">[docs]</a><span class="k">class</span> <span class="nc">AttitudeDeterminationAndControlState</span><span class="p">(</span><span class="n">SubsystemState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">component_states</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">SubsystemHealth</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">SubsystemStatus</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">SubsystemNames</span><span class="o">.</span><span class="n">ADCS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">AttitudeDeterminationAndControlSubsystem</span><span class="p">,</span> <span class="n">component_states</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
    
<div class="viewcode-block" id="AttitudeDeterminationAndControlState.from_subsystem"><a class="viewcode-back" href="../engineering.html#engineering.AttitudeDeterminationAndControlState.from_subsystem">[docs]</a>    <span class="k">def</span> <span class="nf">from_subsystem</span><span class="p">(</span><span class="n">adcs</span><span class="p">:</span> <span class="n">AttitudeDeterminationAndControlSubsystem</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AttitudeDeterminationAndControlState</span><span class="p">(</span><span class="n">adcs</span><span class="o">.</span><span class="n">component_states</span><span class="p">,</span> <span class="n">adcs</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">adcs</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="InertialMeasurementUnitModule"><a class="viewcode-back" href="../engineering.html#engineering.InertialMeasurementUnitModule">[docs]</a><span class="k">class</span> <span class="nc">InertialMeasurementUnitModule</span><span class="p">(</span><span class="n">ComponentModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">parent_subsystem</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> 
                <span class="n">average_power_consumption</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">,</span> 
                <span class="n">f_update</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">IMU</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_subsystem</span><span class="p">,</span> <span class="n">InertialMeasurementUnitState</span><span class="p">,</span> <span class="n">average_power_consumption</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">f_update</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">angular_pos</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angular_vel</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

<div class="viewcode-block" id="InertialMeasurementUnitModule.update_properties"><a class="viewcode-back" href="../engineering.html#engineering.InertialMeasurementUnitModule.update_properties">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update_properties</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span></div>
        <span class="c1"># TODO sense angular position and velocity</span>

<div class="viewcode-block" id="InertialMeasurementUnitModule.perform_task"><a class="viewcode-back" href="../engineering.html#engineering.InertialMeasurementUnitModule.perform_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">perform_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">ComponentTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskStatus</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a task given to this component. </span>
<span class="sd">        Rejects any tasks that is not intended to be performed by this component. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># check if component was the intended performer of this task</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">component</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component task not intended for this component. Initially intended for component </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">. Aborting task...&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>
            
            <span class="n">acquire</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">AttitudeUpdateTask</span><span class="p">):</span>
                <span class="n">acquire</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">angular_pos</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">new_angular_pos</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">angular_vel</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">new_angular_vel</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attitude updated! New state: angular pos=[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_pos</span><span class="si">}</span><span class="s1">], angular vel=[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_vel</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported.&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Aborting task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">acquire</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="c1"># return task abort status</span>
            <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">ABORTED</span></div></div>

<div class="viewcode-block" id="InertialMeasurementUnitState"><a class="viewcode-back" href="../engineering.html#engineering.InertialMeasurementUnitState">[docs]</a><span class="k">class</span> <span class="nc">InertialMeasurementUnitState</span><span class="p">(</span><span class="n">ComponentState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">power_consumed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">power_supplied</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">angular_pos</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                <span class="n">angular_vel</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">IMU</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">InertialMeasurementUnitModule</span><span class="p">,</span> <span class="n">power_consumed</span><span class="p">,</span> <span class="n">power_supplied</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angular_pos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x_i</span> <span class="ow">in</span> <span class="n">angular_pos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angular_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_i</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">angular_vel</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v_i</span> <span class="ow">in</span> <span class="n">angular_vel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angular_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_i</span><span class="p">)</span>

<div class="viewcode-block" id="InertialMeasurementUnitState.from_component"><a class="viewcode-back" href="../engineering.html#engineering.InertialMeasurementUnitState.from_component">[docs]</a>    <span class="k">def</span> <span class="nf">from_component</span><span class="p">(</span><span class="n">imu</span><span class="p">:</span> <span class="n">InertialMeasurementUnitModule</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">InertialMeasurementUnitState</span><span class="p">(</span><span class="n">imu</span><span class="o">.</span><span class="n">power_consumed</span><span class="p">,</span> <span class="n">imu</span><span class="o">.</span><span class="n">power_supplied</span><span class="p">,</span> <span class="n">imu</span><span class="o">.</span><span class="n">angular_pos</span><span class="p">,</span> <span class="n">imu</span><span class="o">.</span><span class="n">angular_vel</span><span class="p">,</span> <span class="n">imu</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">imu</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="ReactionWheelModule"><a class="viewcode-back" href="../engineering.html#engineering.ReactionWheelModule">[docs]</a><span class="k">class</span> <span class="nc">ReactionWheelModule</span><span class="p">(</span><span class="n">ComponentModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">parent_subsystem</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> 
                <span class="n">average_power_consumption</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">OFF</span><span class="p">,</span> 
                <span class="n">f_update</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">REACTION_WHEELS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_subsystem</span><span class="p">,</span> <span class="n">ReactionWheelState</span><span class="p">,</span> <span class="n">average_power_consumption</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">f_update</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">angular_pos</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="c1"># TODO change to 3 axis attitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angular_vel</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="c1"># TODO change to 3 axis attitude</span>

<div class="viewcode-block" id="ReactionWheelModule.update_properties"><a class="viewcode-back" href="../engineering.html#engineering.ReactionWheelModule.update_properties">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update_properties</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span></div>
        <span class="c1"># TODO sense angular position and velocity</span>

<div class="viewcode-block" id="ReactionWheelModule.perform_task"><a class="viewcode-back" href="../engineering.html#engineering.ReactionWheelModule.perform_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">perform_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">ComponentTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskStatus</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a task given to this component. </span>
<span class="sd">        Rejects any tasks that is not intended to be performed by this component. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># check if component was the intended performer of this task</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Performing task&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">component</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component task not intended for this component. Initially intended for component </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">. Aborting task...&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>
            
            <span class="n">acquire</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">AttitudeManeuverTask</span><span class="p">):</span>
                <span class="n">acquire</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="n">slew_torque</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">new_angular_pos</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">*</span><span class="mf">0.05</span> <span class="o">/</span> <span class="nb">pow</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">momentum</span> <span class="o">=</span> <span class="mf">0.09</span> <span class="c1"># Nms, based on Blue Canyon RWP100</span>
                <span class="n">power_consumed</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">slew_torque</span> <span class="o">+</span> <span class="mf">4.51</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">momentum</span><span class="p">,</span><span class="mf">0.47</span><span class="p">)</span> <span class="c1"># from https://digitalcommons.usu.edu/cgi/viewcontent.cgi?article=1080&amp;context=smallsat</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">power_consumed</span><span class="si">}</span><span class="s1"> W of power consumed by attitude maneuver!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">average_power_consumption</span> <span class="o">=</span> <span class="n">power_consumed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">angular_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">new_angular_pos</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">angular_vel</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">new_angular_vel</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="c1"># await self.sim_wait(5.0) TODO not sure if blocking things is really the desired behavior</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attitude changed! New state: angular pos=[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_pos</span><span class="si">}</span><span class="s1">], angular vel=[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_vel</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported.&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>
            <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">DONE</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Aborting task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">acquire</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="c1"># return task abort status</span>
            <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">ABORTED</span></div></div>

<div class="viewcode-block" id="ReactionWheelState"><a class="viewcode-back" href="../engineering.html#engineering.ReactionWheelState">[docs]</a><span class="k">class</span> <span class="nc">ReactionWheelState</span><span class="p">(</span><span class="n">ComponentState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">power_consumed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">power_supplied</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">angular_pos</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                <span class="n">angular_vel</span> <span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">REACTION_WHEELS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ReactionWheelModule</span><span class="p">,</span> <span class="n">power_consumed</span><span class="p">,</span> <span class="n">power_supplied</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angular_pos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x_i</span> <span class="ow">in</span> <span class="n">angular_pos</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angular_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_i</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">angular_vel</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v_i</span> <span class="ow">in</span> <span class="n">angular_vel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angular_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_i</span><span class="p">)</span>

<div class="viewcode-block" id="ReactionWheelState.from_component"><a class="viewcode-back" href="../engineering.html#engineering.ReactionWheelState.from_component">[docs]</a>    <span class="k">def</span> <span class="nf">from_component</span><span class="p">(</span><span class="n">rw</span><span class="p">:</span> <span class="n">ReactionWheelModule</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ReactionWheelState</span><span class="p">(</span><span class="n">rw</span><span class="o">.</span><span class="n">power_consumed</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">power_supplied</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">angular_pos</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">angular_vel</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">rw</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">EPS</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="ElectricPowerSubsystem"><a class="viewcode-back" href="../engineering.html#engineering.ElectricPowerSubsystem">[docs]</a><span class="k">class</span> <span class="nc">ElectricPowerSubsystem</span><span class="p">(</span><span class="n">SubsystemModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">parent_platform_sim</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> 
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">OFF</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describes the agent&#39;s Electric Power Subsystem</span>

<span class="sd">        parent_platform_sim:</span>
<span class="sd">            parent platform simulator module</span>
<span class="sd">        health:</span>
<span class="sd">            health of the component</span>
<span class="sd">        status:</span>
<span class="sd">            status of the component</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">SubsystemNames</span><span class="o">.</span><span class="n">EPS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_platform_sim</span><span class="p">,</span> <span class="n">ElectricPowerSubsystemState</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        
        <span class="c1"># TODO add support for list of components/designer inputs </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="c1"># BatteryModule(self, 100, 1000),</span>
                            <span class="n">PowerSupplyComponent</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">POWER_SUPPLY</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">EPSComponentState</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                          <span class="p">]</span>

<div class="viewcode-block" id="ElectricPowerSubsystem.is_subsystem_critical"><a class="viewcode-back" href="../engineering.html#engineering.ElectricPowerSubsystem.is_subsystem_critical">[docs]</a>    <span class="k">def</span> <span class="nf">is_subsystem_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detects subsystem-level critical state using latest component states received by this subsystem.</span>
<span class="sd">        Returns true when the total power output of the </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">current_power_out_total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">maximum_power_outout</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span><span class="p">:</span>
            <span class="n">component</span> <span class="p">:</span> <span class="n">ComponentModule</span>
            
            <span class="n">comp_state</span> <span class="p">:</span> <span class="n">EPSComponentState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_states</span><span class="p">[</span><span class="n">component</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="n">current_power_out_total</span> <span class="o">+=</span> <span class="n">comp_state</span><span class="o">.</span><span class="n">power_output</span>
            <span class="n">maximum_power_outout</span> <span class="o">+=</span> <span class="n">comp_state</span><span class="o">.</span><span class="n">maximum_power_output</span>

        <span class="k">return</span> <span class="n">current_power_out_total</span><span class="o">/</span><span class="n">maximum_power_outout</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">threshold</span></div>
    
<div class="viewcode-block" id="ElectricPowerSubsystem.is_subsystem_failure"><a class="viewcode-back" href="../engineering.html#engineering.ElectricPowerSubsystem.is_subsystem_failure">[docs]</a>    <span class="k">def</span> <span class="nf">is_subsystem_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detects subsystem-level failure state using latest component states received by this subsystem. </span>
<span class="sd">        It fails when a single component in the subsystem is in a failure state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_component_failure</span><span class="p">()</span></div>

<div class="viewcode-block" id="ElectricPowerSubsystem.decompose_subsystem_task"><a class="viewcode-back" href="../engineering.html#engineering.ElectricPowerSubsystem.decompose_subsystem_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">decompose_subsystem_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span> <span class="p">:</span> <span class="n">SubsystemTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decomposes a subsystem-level task and returns a list of component-level tasks to be performed by this subsystem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">PowerSupplyRequestTask</span><span class="p">):</span>
                <span class="c1"># from all available components, it instructs an available power supply to provide power to a component requesting it</span>
                
                <span class="c1"># unpackage task </span>
                <span class="n">remaining_power_to_supply</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">power_requested</span>
                <span class="n">power_to_supply</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="c1"># check if power is to be provided or stopped</span>
                <span class="c1"># if remaining_power_to_supply &gt; 0:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> is requesting </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">power_requested</span><span class="si">}</span><span class="s1"> [W] to be provided.&#39;</span><span class="p">)</span>

                <span class="c1"># check which components are available to provide power to target</span>
                <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span><span class="p">:</span>
                    <span class="n">component</span> <span class="p">:</span> <span class="n">PowerSupplyComponent</span>
                    <span class="n">power_available</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">maximum_power_output</span> <span class="o">-</span> <span class="n">component</span><span class="o">.</span><span class="n">power_output</span>

                    <span class="k">if</span> <span class="n">power_available</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">remaining_power_to_supply</span> <span class="o">&lt;=</span> <span class="n">power_available</span><span class="p">:</span>
                            <span class="n">power_to_supply</span><span class="p">[</span><span class="n">component</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">remaining_power_to_supply</span>
                            <span class="n">remaining_power_to_supply</span> <span class="o">-=</span> <span class="n">remaining_power_to_supply</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">power_to_supply</span><span class="p">[</span><span class="n">component</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">power_available</span>
                            <span class="n">remaining_power_to_supply</span> <span class="o">-=</span> <span class="n">power_available</span>
                    
                    <span class="k">if</span> <span class="n">remaining_power_to_supply</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                        <span class="k">break</span>
                
                <span class="k">if</span> <span class="n">remaining_power_to_supply</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                    <span class="c1"># if enough power can be provided, send tasks to eps components</span>
                    <span class="n">comp_tasks</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">eps_component_name</span> <span class="ow">in</span> <span class="n">power_to_supply</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Instructing </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">eps_component_name</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> to provide </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> with </span><span class="si">{</span><span class="n">power_to_supply</span><span class="p">[</span><span class="n">eps_component_name</span><span class="p">]</span><span class="si">}</span><span class="s1"> [W] of power...&#39;</span><span class="p">)</span>
                        <span class="n">comp_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">ProvidePowerTask</span><span class="p">(</span><span class="n">eps_component_name</span><span class="p">,</span> <span class="n">power_to_supply</span><span class="p">[</span><span class="n">eps_component_name</span><span class="p">],</span> <span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="p">)</span> <span class="p">)</span>
                    <span class="k">return</span> <span class="n">comp_tasks</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># else abort task</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> cannot meet power request of </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">power_requested</span><span class="si">}</span><span class="s1"> [W].&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">[]</span>
                <span class="c1"># else:</span>
                <span class="c1">#     self.log(f&#39;\&#39;{task.target}\&#39; is requesting {-task.power_requested} [W] to no longer be provided.&#39;,level=logging.INFO)</span>

                <span class="c1">#     for component in self.submodules:</span>
                <span class="c1">#         component : PowerSupplyComponent</span>
                        
                <span class="c1">#         state : EPSComponentState = await component.get_state()</span>

                <span class="c1">#         for component_name in state.components_powered:</span>
                <span class="c1">#             if component_name == task.target:</span>
                <span class="c1">#                 remaining_power_to_supply -= state.components_powered[component_name]</span>
                <span class="c1">#                 power_to_supply[component_name] = -state.components_powered[component_name]</span>
                    
                <span class="c1">#     if remaining_power_to_supply &lt; 1e-6:</span>
                <span class="c1">#         # if enough power can be provided, send tasks to eps components</span>
                <span class="c1">#         comp_tasks = []</span>
                <span class="c1">#         for eps_component_name in power_to_supply:</span>
                <span class="c1">#             self.log(f&#39;Instructing \&#39;{eps_component_name}\&#39; to stop providing \&#39;{task.target}\&#39; with {power_to_supply[eps_component_name]}[W] of power...&#39;,level=logging.INFO)</span>
                <span class="c1">#             comp_tasks.append( ProvidePowerTask(eps_component_name, power_to_supply[eps_component_name], task.target) )</span>
                <span class="c1">#         self.log(f&#39;Done instructing&#39;,level=logging.INFO)</span>
                <span class="c1">#         return comp_tasks</span>
                <span class="c1">#     else:</span>
                <span class="c1">#         # else abort task</span>
                <span class="c1">#         self.log(f&#39;{self.name} cannot meet power stop request of {task.power_requested} [W].&#39;,level=logging.INFO)</span>
                <span class="c1">#         return []</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">decompose_subsystem_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div></div>

<div class="viewcode-block" id="ElectricPowerSubsystemState"><a class="viewcode-back" href="../engineering.html#engineering.ElectricPowerSubsystemState">[docs]</a><span class="k">class</span> <span class="nc">ElectricPowerSubsystemState</span><span class="p">(</span><span class="n">SubsystemState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">component_states</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
                <span class="n">health</span><span class="p">:</span> <span class="n">SubsystemHealth</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">SubsystemStatus</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">SubsystemNames</span><span class="o">.</span><span class="n">EPS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ElectricPowerSubsystem</span><span class="p">,</span> <span class="n">component_states</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>

<div class="viewcode-block" id="ElectricPowerSubsystemState.from_subsystem"><a class="viewcode-back" href="../engineering.html#engineering.ElectricPowerSubsystemState.from_subsystem">[docs]</a>    <span class="k">def</span> <span class="nf">from_subsystem</span><span class="p">(</span><span class="n">eps</span><span class="p">:</span> <span class="n">ElectricPowerSubsystem</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ElectricPowerSubsystemState</span><span class="p">(</span><span class="n">eps</span><span class="o">.</span><span class="n">component_states</span><span class="p">,</span> <span class="n">eps</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">eps</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>



<div class="viewcode-block" id="PowerSupplyComponent"><a class="viewcode-back" href="../engineering.html#engineering.PowerSupplyComponent">[docs]</a><span class="k">class</span> <span class="nc">PowerSupplyComponent</span><span class="p">(</span><span class="n">ComponentModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">name</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                <span class="n">parent_subsystem</span> <span class="p">:</span> <span class="n">Module</span><span class="p">,</span> 
                <span class="n">state_type</span> <span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
                <span class="n">maximum_power_output</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e10</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">,</span> 
                <span class="n">f_update</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describes a generic power supply component within the EPS subsystem</span>

<span class="sd">        parent_subsystem:</span>
<span class="sd">            parent EPS subsystem</span>
<span class="sd">        maximum_power_output:</span>
<span class="sd">            maximum power output of this battery in [W]</span>
<span class="sd">        health:</span>
<span class="sd">            health of the component</span>
<span class="sd">        status:</span>
<span class="sd">            status of the component</span>
<span class="sd">        f_update:</span>
<span class="sd">            frequency of periodic state checks in [Hz]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">average_power_consumption</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent_subsystem</span><span class="p">,</span> <span class="n">state_type</span><span class="p">,</span> <span class="n">average_power_consumption</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">f_update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maximum_power_output</span> <span class="o">=</span> <span class="n">maximum_power_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_output</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">components_powered</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<div class="viewcode-block" id="PowerSupplyComponent.is_critical"><a class="viewcode-back" href="../engineering.html#engineering.PowerSupplyComponent.is_critical">[docs]</a>    <span class="k">def</span> <span class="nf">is_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns true if the current state of the component is critical. </span>
<span class="sd">        Is true when the current power output is within 5% of the maximumim power output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">crit_threshold</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_output</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_power_output</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">crit_threshold</span></div>

<div class="viewcode-block" id="PowerSupplyComponent.is_power_supply_failure"><a class="viewcode-back" href="../engineering.html#engineering.PowerSupplyComponent.is_power_supply_failure">[docs]</a>    <span class="k">def</span> <span class="nf">is_power_supply_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns true if more power is being outputted than the maximum power output</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_output</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_power_output</span> <span class="o">&gt;</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="PowerSupplyComponent.update_properties"><a class="viewcode-back" href="../engineering.html#engineering.PowerSupplyComponent.update_properties">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the current state of the component given a time-step dt</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update_properties</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># update power output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_output</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components_powered</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">power_output</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components_powered</span><span class="p">[</span><span class="n">component</span><span class="p">]</span></div>

<div class="viewcode-block" id="PowerSupplyComponent.perform_task"><a class="viewcode-back" href="../engineering.html#engineering.PowerSupplyComponent.perform_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">perform_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">ComponentTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskStatus</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a task given to this component. </span>
<span class="sd">        Rejects any tasks if the component is in a failure mode of if it is not intended for to be performed by this component. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># check if component was the intended performer of this task</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">component</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component task not intended for this component. Initially intended for component </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">. Aborting task...&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ProvidePowerTask</span><span class="p">):</span>               
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># component is requesting for power to be provided</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_output</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum_power_output</span><span class="p">:</span>
                        <span class="c1"># insuficient power output to perform this task</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component cannot provide </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span><span class="si">}</span><span class="s1"> [W]. Current power output state: (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">power_output</span><span class="si">}</span><span class="s1"> [W]/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_power_output</span><span class="si">}</span><span class="s1"> [W]). Aborting task...&#39;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

                    <span class="c1"># check if component can satisfy power supply demand</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_output</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum_power_output</span><span class="p">:</span>
                        <span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum_power_output</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_output</span>

                    <span class="c1"># update internal power ouput </span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">power_output</span> <span class="o">+=</span> <span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span>

                    <span class="c1"># update internal list of powered components    </span>
                    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components_powered</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">components_powered</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="p">]</span> <span class="o">+=</span> <span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">components_powered</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span>
                    
                    <span class="c1"># inform target component of its new power supply</span>
                    <span class="n">power_supply_task</span> <span class="o">=</span> <span class="n">ReceivePowerTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">ComponentTaskMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">power_supply_task</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Now providing </span><span class="si">{</span> <span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span><span class="si">}</span><span class="s1"> [W] of power to </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">! (Current power output: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">power_output</span><span class="si">}</span><span class="s1">[W]/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_power_output</span><span class="si">}</span><span class="s1">[W])&#39;</span><span class="p">)</span>

                    <span class="c1"># inform target component of its new power supply</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Informing </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> that they are now receiving </span><span class="si">{</span> <span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span><span class="si">}</span><span class="s1"> [W] of power...&#39;</span><span class="p">)</span>
                    <span class="n">power_supply_task</span> <span class="o">=</span> <span class="n">ReceivePowerTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">ComponentTaskMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">power_supply_task</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    
                    <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">DONE</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># component is requesting for power to no longer be provided</span>

                    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components_powered</span><span class="p">:</span>
                        <span class="c1"># check if component can satisfy power supply demand and update internal power output </span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">components_powered</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span><span class="p">):</span>
                            <span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">components_powered</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="p">]</span>

                        <span class="c1"># update internal list of powered components    </span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">components_powered</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="p">]</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                            <span class="c1"># if component is no longer being powered, then remove from dictionary of components powered</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">components_powered</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">components_powered</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="p">]</span> <span class="o">+=</span> <span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Cannot stop proving power to a component that is not being powered by this coomponent.&#39;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

                    <span class="c1"># inform target component of its new power supply</span>
                    <span class="n">power_supply_task</span> <span class="o">=</span> <span class="n">ReceivePowerTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">ComponentTaskMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">power_supply_task</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No longer providing </span><span class="si">{</span> <span class="n">task</span><span class="o">.</span><span class="n">power_to_supply</span><span class="si">}</span><span class="s1"> [W] of power to </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">! (Current power output: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">power_output</span><span class="si">}</span><span class="s1">[W]/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_power_output</span><span class="si">}</span><span class="s1">[W])&#39;</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">DONE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported.&#39;</span><span class="p">)</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span> 
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Aborting task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

            <span class="c1"># release update lock if cancelled during task handling</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="c1"># return task abort status</span>
            <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">ABORTED</span></div></div>

<div class="viewcode-block" id="EPSComponentState"><a class="viewcode-back" href="../engineering.html#engineering.EPSComponentState">[docs]</a><span class="k">class</span> <span class="nc">EPSComponentState</span><span class="p">(</span><span class="n">ComponentState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">name</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">component_type</span> <span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
                <span class="n">power_consumed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">power_supplied</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">power_output</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">maximum_power_output</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">components_powered</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">component_type</span><span class="p">,</span> <span class="n">power_consumed</span><span class="p">,</span> <span class="n">power_supplied</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components_powered</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components_powered</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components_powered</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="n">components_powered</span><span class="p">[</span><span class="n">component</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">power_output</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">power_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maximum_power_output</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">maximum_power_output</span>

<div class="viewcode-block" id="EPSComponentState.from_component"><a class="viewcode-back" href="../engineering.html#engineering.EPSComponentState.from_component">[docs]</a>    <span class="k">def</span> <span class="nf">from_component</span><span class="p">(</span><span class="n">component</span><span class="p">:</span> <span class="n">PowerSupplyComponent</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">EPSComponentState</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="nb">type</span><span class="p">(</span><span class="n">component</span><span class="p">),</span>
                            <span class="n">component</span><span class="o">.</span><span class="n">power_consumed</span><span class="p">,</span>
                            <span class="n">component</span><span class="o">.</span><span class="n">power_supplied</span><span class="p">,</span> 
                            <span class="n">component</span><span class="o">.</span><span class="n">power_output</span><span class="p">,</span> 
                            <span class="n">component</span><span class="o">.</span><span class="n">maximum_power_output</span><span class="p">,</span>
                            <span class="n">component</span><span class="o">.</span><span class="n">components_powered</span><span class="p">,</span>
                            <span class="n">component</span><span class="o">.</span><span class="n">health</span><span class="p">,</span>
                            <span class="n">component</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div>

<div class="viewcode-block" id="EPSComponentState.to_dict"><a class="viewcode-back" href="../engineering.html#engineering.EPSComponentState.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;power_output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_output</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;maximum_power_output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum_power_output</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;components_powered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components_powered</span>

        <span class="k">return</span> <span class="n">out</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span></div>

<div class="viewcode-block" id="BatteryModule"><a class="viewcode-back" href="../engineering.html#engineering.BatteryModule">[docs]</a><span class="k">class</span> <span class="nc">BatteryModule</span><span class="p">(</span><span class="n">PowerSupplyComponent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">parent_subsystem</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> 
                <span class="n">maximum_power_output</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">energy_capacity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">initial_charge</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="n">charging_efficiency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="n">depth_of_discharge</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">OFF</span><span class="p">,</span> 
                <span class="n">f_update</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describes a battery component in the EPS subsystem</span>

<span class="sd">        parent_subsystem:</span>
<span class="sd">            parent EPS subsystem</span>
<span class="sd">        maximum_power_output:</span>
<span class="sd">            maximum power output of this battery in [W]</span>
<span class="sd">        energy_capacity:</span>
<span class="sd">            maximum energy storage capacity in [Whr]</span>
<span class="sd">        initial_charge:</span>
<span class="sd">            initial battery charge percentage from [0, 1]</span>
<span class="sd">        charging_efficiency:</span>
<span class="sd">            charging efficiency from [0, 1]</span>
<span class="sd">        depth_of_discharge:</span>
<span class="sd">            maximum allowable depth of discharge for this battery from [0, 1]</span>
<span class="sd">        health:</span>
<span class="sd">            health of the component</span>
<span class="sd">        status:</span>
<span class="sd">            status of the component</span>
<span class="sd">        f_update:</span>
<span class="sd">            frequency of periodic state checks in [Hz]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">BATTERY</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_subsystem</span><span class="p">,</span> <span class="n">BatteryState</span><span class="p">,</span> <span class="n">maximum_power_output</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">f_update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_capacity</span> <span class="o">=</span> <span class="n">energy_capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_stored</span> <span class="o">=</span> <span class="n">energy_capacity</span> <span class="o">*</span> <span class="n">initial_charge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charging_efficiency</span> <span class="o">=</span> <span class="n">charging_efficiency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_of_discharge</span> <span class="o">=</span> <span class="n">depth_of_discharge</span>

        <span class="k">if</span> <span class="n">initial_charge</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">initial_charge</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Initial charge must be a value within the interval [0, 1]&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">charging_efficiency</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">charging_efficiency</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Charging effciency must be a value within the interval [0, 1]&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">depth_of_discharge</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">depth_of_discharge</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Depth of Discharge must be a value within the interval [0, 1]&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="BatteryModule.is_critical"><a class="viewcode-back" href="../engineering.html#engineering.BatteryModule.is_critical">[docs]</a>    <span class="k">def</span> <span class="nf">is_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns true if the current state of the component is critical. </span>
<span class="sd">        Is true when the state of discharge is within 5% of the battery&#39;s maximum depth of discharge and the battery</span>
<span class="sd">        is being drained or when the battery is charging and it reaches 95% charging capacity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">crit_threshold</span> <span class="o">=</span> <span class="mf">0.05</span>
        
        <span class="n">batt_crit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">batt_crit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_stored</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_capacity</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_of_discharge</span> <span class="o">-</span> <span class="n">crit_threshold</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">batt_crit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_stored</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_capacity</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">crit_threshold</span>
        
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_critical</span><span class="p">()</span> <span class="ow">or</span> <span class="n">batt_crit</span></div>

<div class="viewcode-block" id="BatteryModule.is_failed"><a class="viewcode-back" href="../engineering.html#engineering.BatteryModule.is_failed">[docs]</a>    <span class="k">def</span> <span class="nf">is_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns true if the current state of the component is a failure state.</span>
<span class="sd">        Is true when the state of discharge equals or surpasses the battery&#39;s maximum depth of discharge and the battery</span>
<span class="sd">        is being drained or when the battery is charging and reaches full charge capacity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batt_failed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">batt_failed</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_stored</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_capacity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_of_discharge</span> 
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">batt_failed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_stored</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_capacity</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_failed</span><span class="p">()</span> <span class="ow">or</span> <span class="n">batt_failed</span></div>

<div class="viewcode-block" id="BatteryModule.is_power_supply_failure"><a class="viewcode-back" href="../engineering.html#engineering.BatteryModule.is_power_supply_failure">[docs]</a>    <span class="k">def</span> <span class="nf">is_power_supply_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns true if more power is being outputted than the maximum power output or when the battery is still being charged</span>
<span class="sd">        after it has reached its maximum capacity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">battery_at_capacity</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_stored</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_capacity</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span>
        <span class="n">is_charging</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_supplied</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">battery_over_charge</span> <span class="o">=</span> <span class="n">battery_at_capacity</span> <span class="ow">and</span> <span class="n">is_charging</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_power_supply_failure</span><span class="p">()</span> <span class="ow">or</span> <span class="n">battery_over_charge</span></div>

<div class="viewcode-block" id="BatteryModule.wait_for_failure"><a class="viewcode-back" href="../engineering.html#engineering.BatteryModule.wait_for_failure">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count downs to the next predicted failure state of this component given that the current configuration is maintained.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="c1"># battery is discharging, count-down to next predicted discharge below maximum depth of discharge</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_of_discharge</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_capacity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_stored</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="c1"># battery is charging, count-down to full battery status</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_capacity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_stored</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># battery is not being used nor being charged, wait indefinitively </span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="BatteryModule.update_properties"><a class="viewcode-back" href="../engineering.html#engineering.BatteryModule.update_properties">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the current state of the component given a time-step dt</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update_properties</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># update power differential tracker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_supplied</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">charging_efficiency</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">power_output</span>

        <span class="c1"># update energy storage</span>
        <span class="n">dE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dp</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_stored</span> <span class="o">+</span> <span class="n">dE</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy_stored</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_stored</span> <span class="o">+</span> <span class="n">dE</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_capacity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy_stored</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_capacity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">energy_stored</span> <span class="o">+=</span> <span class="n">dE</span>        </div></div>

<div class="viewcode-block" id="BatteryState"><a class="viewcode-back" href="../engineering.html#engineering.BatteryState">[docs]</a><span class="k">class</span> <span class="nc">BatteryState</span><span class="p">(</span><span class="n">EPSComponentState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">power_consumed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">power_supplied</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">power_output</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">maximum_power_output</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">components_powered</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                <span class="n">energy_stored</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">energy_capacity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">charging_efficiency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">depth_of_discharge</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">BATTERY</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">power_consumed</span><span class="p">,</span> <span class="n">power_supplied</span><span class="p">,</span> <span class="n">power_output</span><span class="p">,</span> <span class="n">maximum_power_output</span><span class="p">,</span> <span class="n">components_powered</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_stored</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">energy_stored</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_capacity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">energy_capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charging_efficiency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">charging_efficiency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_of_discharge</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">depth_of_discharge</span>

<div class="viewcode-block" id="BatteryState.from_component"><a class="viewcode-back" href="../engineering.html#engineering.BatteryState.from_component">[docs]</a>    <span class="k">def</span> <span class="nf">from_component</span><span class="p">(</span><span class="n">battery</span><span class="p">:</span> <span class="n">BatteryModule</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BatteryState</span><span class="p">(</span><span class="n">battery</span><span class="o">.</span><span class="n">power_consumed</span><span class="p">,</span> 
                            <span class="n">battery</span><span class="o">.</span><span class="n">power_supplied</span><span class="p">,</span> 
                            <span class="n">battery</span><span class="o">.</span><span class="n">power_output</span><span class="p">,</span> 
                            <span class="n">battery</span><span class="o">.</span><span class="n">maximum_power_output</span><span class="p">,</span> 
                            <span class="n">battery</span><span class="o">.</span><span class="n">components_powered</span><span class="p">,</span>
                            <span class="n">battery</span><span class="o">.</span><span class="n">energy_stored</span><span class="p">,</span> 
                            <span class="n">battery</span><span class="o">.</span><span class="n">energy_capacity</span><span class="p">,</span> 
                            <span class="n">battery</span><span class="o">.</span><span class="n">charging_efficiency</span><span class="p">,</span> 
                            <span class="n">battery</span><span class="o">.</span><span class="n">depth_of_discharge</span><span class="p">,</span> 
                            <span class="n">battery</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> 
                            <span class="n">battery</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">COMMS</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="CommsSubsystem"><a class="viewcode-back" href="../engineering.html#engineering.CommsSubsystem">[docs]</a><span class="k">class</span> <span class="nc">CommsSubsystem</span><span class="p">(</span><span class="n">SubsystemModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">parent_platform_sim</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> 
                <span class="n">buffer_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span>
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Represents the communications subsystem in an agent. Can receive and transmit messages between agents.</span>
<span class="sd">        parent_platform_sim:</span>
<span class="sd">            platform simulation that the subsystem exists in</span>
<span class="sd">        buffer_size:</span>
<span class="sd">            size of the buffer in bytes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">SubsystemNames</span><span class="o">.</span><span class="n">COMMS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_platform_sim</span><span class="p">,</span> <span class="n">CommsSubsystemState</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">TransmitterComponent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">),</span>
                            <span class="n">ReceiverComponent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">)</span>
                            <span class="p">]</span>

<div class="viewcode-block" id="CommsSubsystem.activate"><a class="viewcode-back" href="../engineering.html#engineering.CommsSubsystem.activate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

        <span class="c1"># instruct receiver to listen for transmissions</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ReceiveMessageTransmission</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">ComponentTaskMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ComponentNames</span><span class="o">.</span><span class="n">RECEIVER</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="CommsSubsystemState"><a class="viewcode-back" href="../engineering.html#engineering.CommsSubsystemState">[docs]</a><span class="k">class</span> <span class="nc">CommsSubsystemState</span><span class="p">(</span><span class="n">SubsystemState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_states</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">health</span><span class="p">:</span> <span class="n">SubsystemHealth</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">SubsystemStatus</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">SubsystemNames</span><span class="o">.</span><span class="n">COMMS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">CommsSubsystem</span><span class="p">,</span> <span class="n">component_states</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>

<div class="viewcode-block" id="CommsSubsystemState.from_subsystem"><a class="viewcode-back" href="../engineering.html#engineering.CommsSubsystemState.from_subsystem">[docs]</a>    <span class="k">def</span> <span class="nf">from_subsystem</span><span class="p">(</span><span class="n">comms</span> <span class="p">:</span> <span class="n">CommsSubsystem</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CommsSubsystemState</span><span class="p">(</span><span class="n">comms</span><span class="o">.</span><span class="n">component_states</span><span class="p">,</span> <span class="n">comms</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">comms</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="TransmitterComponent"><a class="viewcode-back" href="../engineering.html#engineering.TransmitterComponent">[docs]</a><span class="k">class</span> <span class="nc">TransmitterComponent</span><span class="p">(</span><span class="n">ComponentModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">parent_subsystem</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span> 
                <span class="n">average_power_consumption</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">buffer_capacity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">OFF</span><span class="p">,</span> 
                <span class="n">f_update</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describes a receiver transmitter capable of sending messages to other agents</span>

<span class="sd">        parent_subsystem:</span>
<span class="sd">            parent comms subsystem</span>
<span class="sd">        average_power_consumption:</span>
<span class="sd">            average power consumption in [W]</span>
<span class="sd">        buffer_capacity:</span>
<span class="sd">            size of the buffer in [Mbytes]</span>
<span class="sd">        health:</span>
<span class="sd">            health of the component</span>
<span class="sd">        status:</span>
<span class="sd">            status of the component</span>
<span class="sd">        f_update:</span>
<span class="sd">            frequency of periodic state checks in [Hz]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">TRANSMITTER</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_subsystem</span><span class="p">,</span> <span class="n">TransmitterState</span><span class="p">,</span> <span class="n">average_power_consumption</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">f_update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">=</span> <span class="n">buffer_capacity</span> <span class="o">*</span> <span class="mf">1e6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="TransmitterComponent.activate"><a class="viewcode-back" href="../engineering.html#engineering.TransmitterComponent.activate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="TransmitterComponent.internal_message_handler"><a class="viewcode-back" href="../engineering.html#engineering.TransmitterComponent.internal_message_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">internal_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InternalMessage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes messages being sent to this component. Only accepts task messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="c1"># this module is NOT the intended receiver for this message. Forwarding to rightful destination</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received internal message intended for </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span><span class="si">}</span><span class="s1">. Rerouting message...&#39;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ComponentTaskMessage</span><span class="p">):</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_task</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received a task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ComponentAbortTask</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">aborts</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ComponentMaintenanceTask</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">maintenance_tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">TransmitMessageTask</span><span class="p">):</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

                    <span class="n">t_msg</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">msg</span>
                    <span class="n">t_msg_str</span> <span class="o">=</span> <span class="n">t_msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
                    <span class="n">t_msg_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_msg_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">+</span> <span class="n">t_msg_length</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Acepted out-going transmission into buffer!&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">+=</span> <span class="n">t_msg_length</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Out-going message of length </span><span class="si">{</span><span class="n">t_msg_length</span><span class="si">}</span><span class="s1"> now stored in out-going buffer (current state: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rejected out-going transmission into buffer.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Out-going buffer cannot store out-going message of length </span><span class="si">{</span><span class="n">t_msg_length</span><span class="si">}</span><span class="s1"> (current state: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="si">}</span><span class="s1">). Discarding message...&#39;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>                   
            
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">EnvironmentBroadcastMessage</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received an environment event of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environment_events</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

            <span class="c1"># elif isinstance(msg.content, InterNodeMessage):</span>
            <span class="c1">#     self.log(f&#39;Received an internode message!&#39;,level=logging.INFO)</span>
            <span class="c1">#     task_msg = TransmitMessageTask(AgentModuleTypes.IRIDIUM_ENGINEERING_MODULE,msg,1.0)</span>
            <span class="c1">#     await self.tasks.put(task_msg)</span>
            
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">MeasurementRequest</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received a measurement request!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                <span class="n">inter_node_msg</span> <span class="o">=</span> <span class="n">InterNodeMeasurementRequestMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;Iridium&quot;</span><span class="p">,</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">task_msg</span> <span class="o">=</span> <span class="n">TransmitMessageTask</span><span class="p">(</span><span class="s2">&quot;Iridium&quot;</span><span class="p">,</span><span class="n">inter_node_msg</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task_msg</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">InterNodeDownlinkMessage</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received a downlink message!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                <span class="n">data_msg</span> <span class="p">:</span> <span class="n">DataMessage</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">content</span>
                <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">data_msg</span><span class="o">.</span><span class="n">get_target</span><span class="p">()</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">data_msg</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Transmitting result from (</span><span class="si">{</span><span class="n">lat</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">lon</span><span class="si">}</span><span class="s1">) taken at time </span><span class="si">{</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                <span class="n">task_msg</span> <span class="o">=</span> <span class="n">TransmitMessageTask</span><span class="p">(</span><span class="s2">&quot;Central Node&quot;</span><span class="p">,</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task_msg</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Internal message of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported. Discarding message...&#39;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span>  </div>

<div class="viewcode-block" id="TransmitterComponent.is_critical"><a class="viewcode-back" href="../engineering.html#engineering.TransmitterComponent.is_critical">[docs]</a>    <span class="k">def</span> <span class="nf">is_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_critical</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">-</span><span class="n">threshold</span> </div>

<div class="viewcode-block" id="TransmitterComponent.is_failed"><a class="viewcode-back" href="../engineering.html#engineering.TransmitterComponent.is_failed">[docs]</a>    <span class="k">def</span> <span class="nf">is_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_failed</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">&gt;=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="TransmitterComponent.perform_task"><a class="viewcode-back" href="../engineering.html#engineering.TransmitterComponent.perform_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">perform_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">ComponentTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskStatus</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a task given to this component. </span>
<span class="sd">        Rejects any tasks if the component is in a failure mode of if it is not intended for to be performed by this component. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># check if component was the intended performer of this task</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">component</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component task not intended for this component. Initially intended for component </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">. Aborting task...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">TransmitMessageTask</span><span class="p">):</span>
                <span class="c1"># create task variables</span>
                <span class="n">wait_for_access_start</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">transmit_msg</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">wait_for_access_end</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">wait_for_access_end_event</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">wait_for_message_timeout</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># unpackage message</span>
                <span class="n">msg</span> <span class="p">:</span> <span class="n">InterNodeMessage</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">msg</span>
                <span class="c1"># wait for access to target node</span>
                <span class="c1">#wait_for_access_start = asyncio.create_task( self.wait_for_access_start(msg.dst) )</span>
                <span class="c1">#await wait_for_access_start</span>
                <span class="c1"># wait for msg to be transmitted successfully or interrupted due to access end or message timeout</span>
                <span class="n">transmit_msg</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">transmit_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">)</span>
                <span class="c1">#wait_for_access_end = asyncio.create_task( self.wait_for_access_end(msg.dst) )</span>
                <span class="c1">#wait_for_access_end_event = asyncio.create_task( self.access_events[msg.dst].wait_end() ) </span>
                <span class="c1">#wait_for_message_timeout = asyncio.create_task( self.sim_wait(100.0) )</span>
                <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span><span class="n">transmit_msg</span><span class="p">]</span> <span class="c1"># TODO add waits back:  wait_for_access_end, wait_for_access_end_event</span>

                <span class="n">_</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_COMPLETED</span><span class="p">)</span>
                
                <span class="c1"># cancel all pending processes</span>
                <span class="k">for</span> <span class="n">pending_task</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cancelling pending processes!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                    <span class="n">pending_task</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span>
                    <span class="n">pending_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cancelled pending processes!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                <span class="c1"># remove message from out-going buffer</span>
                <span class="c1"># await self.remove_msg_from_buffer(msg)</span>
                <span class="c1"># self.access_events.pop(msg.dst)</span>

                <span class="c1"># return task completion status                </span>
                <span class="k">if</span> <span class="n">transmit_msg</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="ow">and</span> <span class="n">transmit_msg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Successfully transmitted message of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1"> to target </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">!&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SENT, </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">AGENT_TO_AGENT_MESSAGE</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">DONE</span>

                <span class="c1"># elif (wait_for_access_end.done() and wait_for_access_end not in pending) or (wait_for_access_end_event.done() and wait_for_access_end_event not in pending):</span>
                <span class="c1">#     self.log(f&#39;Access to target \&#39;{msg.dst}\&#39; lost during transmission of message of type {type(msg)}!&#39;,level=logging.DEBUG)</span>
                <span class="c1">#     raise asyncio.CancelledError</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Message of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1"> timed out!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported.&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span> 
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Aborting task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

            <span class="c1"># release update lock if cancelled during task handling</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="c1"># cancel any task that&#39;s not yet completed</span>
            <span class="c1"># if not wait_for_access_start.done():</span>
            <span class="c1">#     wait_for_access_start.cancel()</span>
            <span class="c1">#     await wait_for_access_start</span>

            <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="n">process</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                    <span class="k">await</span> <span class="n">process</span>

            <span class="c1"># return task abort status</span>
            <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">ABORTED</span></div>

<div class="viewcode-block" id="TransmitterComponent.transmit_message"><a class="viewcode-back" href="../engineering.html#engineering.TransmitterComponent.transmit_message">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">transmit_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InterNodeMessage</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># reformat message</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="n">msg_json</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
            <span class="n">parent_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span>
            <span class="c1"># connect socket to destination </span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">parent_agent</span><span class="o">.</span><span class="n">AGENT_TO_PORT_MAP</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connecting to agent </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="s1"> through port number </span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_out</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connected to agent </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

            <span class="c1"># submit request</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Transmitting a message of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1"> (from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="s1">)...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_out_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Acquired lock.&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_out</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">msg_json</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s1"> message sent successfully. Awaiting response...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                        
            <span class="c1"># wait for server reply</span>
            <span class="k">await</span> <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_out</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received message reception confirmation!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>  
            <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_out_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Released agent_socket_out&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>      

            <span class="c1"># disconnect socket from destination</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Disconnecting from agent </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_out</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tcp://localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Disconnected from agent </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">dst</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;asyncio CancelledError in transmit_message&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_out_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Released agent_socket_out lock.&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="k">return</span></div>


    <span class="c1"># async def transmit_message(self, msg: InterNodeMessage):</span>
    <span class="c1">#     # reformat message</span>
    <span class="c1">#     msg.src = self.name</span>
    <span class="c1">#     msg_json = msg.to_json()</span>

    <span class="c1">#     # connect socket to destination </span>
    <span class="c1">#     port = self.AGENT_TO_PORT_MAP[msg.dst]</span>
    <span class="c1">#     self.log(f&#39;Connecting to agent {msg.dst} through port number {port}...&#39;)</span>
    <span class="c1">#     self.agent_socket_out.connect(f&quot;tcp://localhost:{port}&quot;)</span>
    <span class="c1">#     self.log(f&#39;Connected to agent {msg.dst}!&#39;)</span>

    <span class="c1">#     # submit request</span>
    <span class="c1">#     self.log(f&#39;Transmitting a message of type {type(msg)} (from {self.name} to {msg.dst})...&#39;)</span>
    <span class="c1">#     await self.agent_socket_out_lock.acquire()</span>
    <span class="c1">#     await self.agent_socket_out.send_json(msg_json)</span>
    <span class="c1">#     self.log(f&#39;{type(msg)} message sent successfully. Awaiting response...&#39;)</span>
        
    <span class="c1">#     # wait for server reply</span>
    <span class="c1">#     await self.agent_socket_out.recv()</span>
    <span class="c1">#     self.agent_socket_out_lock.release()</span>
    <span class="c1">#     self.log(f&#39;Received message reception confirmation!&#39;)      </span>

    <span class="c1">#     # disconnect socket from destination</span>
    <span class="c1">#     self.log(f&#39;Disconnecting from agent {msg.dst}...&#39;)</span>
    <span class="c1">#     self.agent_socket_out.disconnect(f&quot;tcp://localhost:{port}&quot;)</span>
    <span class="c1">#     self.log(f&#39;Disconnected from agent {msg.dst}!&#39;)</span>

<div class="viewcode-block" id="TransmitterComponent.remove_msg_from_buffer"><a class="viewcode-back" href="../engineering.html#engineering.TransmitterComponent.remove_msg_from_buffer">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">remove_msg_from_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span> <span class="p">:</span> <span class="n">InterNodeMessage</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Removing message from out-going buffer...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

            <span class="n">msg_str</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
            <span class="n">msg_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">-</span> <span class="n">msg_length</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">-=</span> <span class="n">msg_length</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Message sucessfully removed from buffer!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="TransmitterComponent.wait_for_access_start"><a class="viewcode-back" href="../engineering.html#engineering.TransmitterComponent.wait_for_access_start">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for_access_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">AgentAccessSenseMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="n">response</span> <span class="p">:</span> <span class="n">AgentAccessSenseMessage</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_environment_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_FREQUENCY</span><span class="p">)</span>
                <span class="n">response</span> <span class="p">:</span> <span class="n">AgentAccessSenseMessage</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_environment_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Response </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1"> in wait_for_access_start in perform_task&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">EventPair</span><span class="p">()</span>        

            <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">trigger_start</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="TransmitterComponent.wait_for_access_end"><a class="viewcode-back" href="../engineering.html#engineering.TransmitterComponent.wait_for_access_end">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">wait_for_access_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">AgentAccessSenseMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="n">response</span> <span class="p">:</span> <span class="n">AgentAccessSenseMessage</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_environment_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Raising asyncio cancelled error&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;After response is none if&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">response</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_wait</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE_FREQUENCY</span><span class="p">)</span>
                <span class="n">response</span> <span class="p">:</span> <span class="n">AgentAccessSenseMessage</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_environment_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">EventPair</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">trigger_end</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;In except handler in wait_for_access_end&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="TransmitterComponent.environment_event_handler"><a class="viewcode-back" href="../engineering.html#engineering.TransmitterComponent.environment_event_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">environment_event_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_msg</span> <span class="p">:</span> <span class="n">EnvironmentBroadcastMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Affects the component depending on the type of event being received.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event_msg</span><span class="p">,</span> <span class="n">AgentAccessEventBroadcastMessage</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event_msg</span><span class="o">.</span><span class="n">rise</span> <span class="ow">and</span> <span class="n">event_msg</span><span class="o">.</span><span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">:</span>
                <span class="c1"># an end of access event for a target agent has been recevied</span>

                <span class="c1"># fire end of access event</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">[</span><span class="n">event_msg</span><span class="p">]</span><span class="o">.</span><span class="n">trigger_end</span><span class="p">()</span>
                
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div></div>

<div class="viewcode-block" id="TransmitterState"><a class="viewcode-back" href="../engineering.html#engineering.TransmitterState">[docs]</a><span class="k">class</span> <span class="nc">TransmitterState</span><span class="p">(</span><span class="n">ComponentState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">power_consumed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">power_supplied</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">buffer_capacity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">buffer_allocated</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span><span class="p">,</span> 
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">TRANSMITTER</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">TransmitterComponent</span><span class="p">,</span> <span class="n">power_consumed</span><span class="p">,</span> <span class="n">power_supplied</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">=</span> <span class="n">buffer_capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="n">buffer_allocated</span>

<div class="viewcode-block" id="TransmitterState.from_component"><a class="viewcode-back" href="../engineering.html#engineering.TransmitterState.from_component">[docs]</a>    <span class="k">def</span> <span class="nf">from_component</span><span class="p">(</span><span class="n">transmitter</span><span class="p">:</span> <span class="n">TransmitterComponent</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TransmitterState</span><span class="p">(</span><span class="n">transmitter</span><span class="o">.</span><span class="n">power_consumed</span><span class="p">,</span> <span class="n">transmitter</span><span class="o">.</span><span class="n">power_supplied</span><span class="p">,</span> <span class="n">transmitter</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="p">,</span> <span class="n">transmitter</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="p">,</span> <span class="n">transmitter</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">transmitter</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="ReceiverComponent"><a class="viewcode-back" href="../engineering.html#engineering.ReceiverComponent">[docs]</a><span class="k">class</span> <span class="nc">ReceiverComponent</span><span class="p">(</span><span class="n">ComponentModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">parent_subsystem</span><span class="p">:</span> <span class="n">Module</span><span class="p">,</span>
                <span class="n">average_power_consumption</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">buffer_capacity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span> <span class="o">=</span> <span class="n">ComponentHealth</span><span class="o">.</span><span class="n">NOMINAL</span><span class="p">,</span>
                <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span> <span class="o">=</span> <span class="n">ComponentStatus</span><span class="o">.</span><span class="n">ON</span><span class="p">,</span> 
                <span class="n">f_update</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describes a radio receiver capable of sending messages to other agents</span>

<span class="sd">        parent_subsystem:</span>
<span class="sd">            parent comms subsystem</span>
<span class="sd">        average_power_consumption:</span>
<span class="sd">            average power consumption in [W]</span>
<span class="sd">        buffer_capacity:</span>
<span class="sd">            size of the buffer in [Mbytes]</span>
<span class="sd">        health:</span>
<span class="sd">            health of the component</span>
<span class="sd">        status:</span>
<span class="sd">            status of the component</span>
<span class="sd">        f_update:</span>
<span class="sd">            frequency of periodic state checks in [Hz]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">RECEIVER</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_subsystem</span><span class="p">,</span> <span class="n">ReceiverState</span><span class="p">,</span> <span class="n">average_power_consumption</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">f_update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">=</span> <span class="n">buffer_capacity</span> <span class="o">*</span> <span class="mf">1e6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="ReceiverComponent.activate"><a class="viewcode-back" href="../engineering.html#engineering.ReceiverComponent.activate">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ReceiveMessageTransmission</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span></div>

<div class="viewcode-block" id="ReceiverComponent.is_critical"><a class="viewcode-back" href="../engineering.html#engineering.ReceiverComponent.is_critical">[docs]</a>    <span class="k">def</span> <span class="nf">is_critical</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_critical</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">-</span><span class="n">threshold</span> </div>

<div class="viewcode-block" id="ReceiverComponent.is_failed"><a class="viewcode-back" href="../engineering.html#engineering.ReceiverComponent.is_failed">[docs]</a>    <span class="k">def</span> <span class="nf">is_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_failed</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">&gt;=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="ReceiverComponent.perform_task"><a class="viewcode-back" href="../engineering.html#engineering.ReceiverComponent.perform_task">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">perform_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">ComponentTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskStatus</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Listens for any incoming transmissions. Needs to be told to start a ReceiveMessageTransmission</span>
<span class="sd">        task from its parent subsystem or CNDH subsystem at the beginning of the simulation otherwise</span>
<span class="sd">        all messages will not be received</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>        
            <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">agent_lock</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># check if component was the intended performer of this task</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">component</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Component task not intended for this component. Initially intended for component </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">component</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">. Aborting task...&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ReceiveMessageTransmission</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Starting transmission reception task.&#39;</span><span class="p">)</span>

                <span class="c1"># gain access to incoming agent message port from parent agent</span>
                <span class="n">parent_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_top_module</span><span class="p">()</span>
                <span class="n">agent_lock</span> <span class="o">=</span> <span class="k">await</span> <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_in_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Communication port acquired.&#39;</span><span class="p">)</span>

                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">msg_dict</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># listen for messages from other agents</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Waiting for agent messages...&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                    <span class="n">msg_json</span> <span class="o">=</span> <span class="k">await</span> <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_in</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Agent message received!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                    <span class="n">blank</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">blank_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">blank</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_in</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">blank_json</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">InterNodeMessage</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">msg_json</span><span class="p">)</span>
                    <span class="n">msg_dict</span> <span class="o">=</span> <span class="n">InterNodeMessage</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="c1"># check if message can fit in incoming buffer</span>
                    <span class="n">msg_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg_dict</span><span class="p">)</span>
                    <span class="n">msg_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

                    <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">+</span> <span class="n">msg_length</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">+=</span> <span class="n">msg_length</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Incoming message of length </span><span class="si">{</span><span class="n">msg_length</span><span class="si">}</span><span class="s1"> now stored in incoming buffer (current state: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>
                
                        <span class="c1"># handle request</span>
                        <span class="n">msg_type</span> <span class="p">:</span> <span class="n">InterNodeMessageTypes</span> <span class="o">=</span> <span class="n">InterNodeMessageTypes</span><span class="p">[</span><span class="n">msg_dict</span><span class="p">[</span><span class="s1">&#39;@type&#39;</span><span class="p">]]</span>

                        <span class="k">if</span> <span class="n">msg_type</span> <span class="ow">is</span> <span class="n">InterNodeMessageTypes</span><span class="o">.</span><span class="n">PRINT_MESSAGE</span><span class="p">:</span>
                            <span class="c1"># unpack message</span>
                            <span class="n">msg</span> <span class="p">:</span> <span class="n">PrintMessage</span> <span class="o">=</span> <span class="n">PrintMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">msg_dict</span><span class="p">)</span>
                            
                            <span class="c1"># handle message </span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received print instruction: </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>

                        <span class="c1"># elif msg_type is InterNodeMessageTypes.PLANNER_MESSAGE:</span>
                        <span class="c1">#     pass</span>
                        <span class="k">elif</span> <span class="n">msg_type</span> <span class="ow">is</span> <span class="n">InterNodeMessageTypes</span><span class="o">.</span><span class="n">MEASUREMENT_REQUEST</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="p">:</span> <span class="n">InterNodeMessage</span> <span class="o">=</span> <span class="n">InterNodeMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">msg_dict</span><span class="p">)</span>
                            <span class="n">msg_contents</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
                            <span class="n">msg_contents</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg_contents</span><span class="p">)</span>
                            <span class="n">measurement_request</span> <span class="o">=</span> <span class="n">MeasurementRequest</span><span class="p">(</span><span class="n">msg_contents</span><span class="p">[</span><span class="s2">&quot;_type&quot;</span><span class="p">],</span><span class="n">msg_contents</span><span class="p">[</span><span class="s2">&quot;_target&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">msg_contents</span><span class="p">[</span><span class="s2">&quot;_target&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">msg_contents</span><span class="p">[</span><span class="s2">&quot;_science_val&quot;</span><span class="p">],</span><span class="n">msg_contents</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">])</span>
                            <span class="n">req_msg</span> <span class="o">=</span> <span class="n">InternalMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">AgentModuleTypes</span><span class="o">.</span><span class="n">PLANNING_MODULE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">measurement_request</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sending measurement request to planning module (hopefully)!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">req_msg</span><span class="p">)</span> <span class="c1"># send measurement request to planning module</span>
                        <span class="c1"># elif msg_type is InterNodeMessageTypes.MEASUREMENT_MESSAGE:</span>
                        <span class="c1">#     pass</span>
                        <span class="c1"># elif msg_type is InterNodeMessageTypes.INFORMATION_REQUEST:</span>
                        <span class="c1">#     pass</span>
                        <span class="c1"># elif msg_type is InterNodeMessageTypes.INFORMATION_MESSAGE:</span>
                        <span class="c1">#     pass</span>
                        <span class="k">elif</span> <span class="n">msg_type</span> <span class="ow">is</span> <span class="n">InterNodeMessageTypes</span><span class="o">.</span><span class="n">DOWNLINK</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received downlink message!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
                            <span class="n">msg</span> <span class="p">:</span> <span class="n">InterNodeDownlinkMessage</span> <span class="o">=</span> <span class="n">InterNodeDownlinkMessage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">msg_dict</span><span class="p">)</span>
                            <span class="n">downlink_msg</span> <span class="o">=</span> <span class="n">InternalMessage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">AgentModuleTypes</span><span class="o">.</span><span class="n">SCIENCE_MODULE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sending downlink message to science module (hopefully)!&#39;</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">downlink_msg</span><span class="p">)</span> <span class="c1"># send measurement request to planning module</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Internode message of type </span><span class="si">{</span><span class="n">msg_type</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> not yet supported. Discarding message...&#39;</span><span class="p">)</span>

                        <span class="n">acquired</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">-=</span> <span class="n">msg_length</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Incoming message of length </span><span class="si">{</span><span class="n">msg_length</span><span class="si">}</span><span class="s1"> now stored in incoming buffer (current state: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="n">acquired</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;RECEIVED, </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logger_type</span><span class="o">=</span><span class="n">LoggerTypes</span><span class="o">.</span><span class="n">AGENT_TO_AGENT_MESSAGE</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Incoming buffer cannot store incoming message of length </span><span class="si">{</span><span class="n">msg_length</span><span class="si">}</span><span class="s1"> (current state: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="si">}</span><span class="s1">). Discarding message...&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported.&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Aborting task of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

            <span class="c1"># release </span>
            <span class="k">if</span> <span class="n">agent_lock</span><span class="p">:</span>
                <span class="n">parent_agent</span><span class="o">.</span><span class="n">agent_socket_in_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="c1"># release update lock if cancelled during task handling</span>
            <span class="k">if</span> <span class="n">acquired</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="c1"># return task abort status</span>
            <span class="k">return</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">ABORTED</span></div>

<div class="viewcode-block" id="ReceiverComponent.environment_event_handler"><a class="viewcode-back" href="../engineering.html#engineering.ReceiverComponent.environment_event_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">environment_event_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_msg</span> <span class="p">:</span> <span class="n">EnvironmentBroadcastMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Affects the component depending on the type of event being received.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event_msg</span><span class="p">,</span> <span class="n">AgentAccessEventBroadcastMessage</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event_msg</span><span class="o">.</span><span class="n">rise</span> <span class="ow">and</span> <span class="n">event_msg</span><span class="o">.</span><span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">:</span>
                <span class="c1"># an end of access event for a target agent has been recevied</span>

                <span class="c1"># fire end of access event</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">access_events</span><span class="p">[</span><span class="n">event_msg</span><span class="p">]</span><span class="o">.</span><span class="n">trigger_end</span><span class="p">()</span>
                
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="ReceiverState"><a class="viewcode-back" href="../engineering.html#engineering.ReceiverState">[docs]</a><span class="k">class</span> <span class="nc">ReceiverState</span><span class="p">(</span><span class="n">ComponentState</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">power_consumed</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">power_supplied</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                <span class="n">buffer_capacity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">buffer_allocated</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="n">health</span><span class="p">:</span> <span class="n">ComponentHealth</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">ComponentStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ComponentNames</span><span class="o">.</span><span class="n">RECEIVER</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ReceiverComponent</span><span class="p">,</span> <span class="n">power_consumed</span><span class="p">,</span> <span class="n">power_supplied</span><span class="p">,</span> <span class="n">health</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_capacity</span> <span class="o">=</span> <span class="n">buffer_capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_allocated</span> <span class="o">=</span> <span class="n">buffer_allocated</span>

<div class="viewcode-block" id="ReceiverState.from_component"><a class="viewcode-back" href="../engineering.html#engineering.ReceiverState.from_component">[docs]</a>    <span class="k">def</span> <span class="nf">from_component</span><span class="p">(</span><span class="n">receiver</span><span class="p">:</span> <span class="n">ReceiverComponent</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ReceiverState</span><span class="p">(</span><span class="n">receiver</span><span class="o">.</span><span class="n">power_consumed</span><span class="p">,</span> <span class="n">receiver</span><span class="o">.</span><span class="n">power_supplied</span><span class="p">,</span> <span class="n">receiver</span><span class="o">.</span><span class="n">buffer_capacity</span><span class="p">,</span> <span class="n">receiver</span><span class="o">.</span><span class="n">buffer_allocated</span><span class="p">,</span> <span class="n">receiver</span><span class="o">.</span><span class="n">health</span><span class="p">,</span> <span class="n">receiver</span><span class="o">.</span><span class="n">status</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="PlatformSim"><a class="viewcode-back" href="../engineering.html#engineering.PlatformSim">[docs]</a><span class="k">class</span> <span class="nc">PlatformSim</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_module</span> <span class="p">:</span> <span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">EngineeringModuleParts</span><span class="o">.</span><span class="n">PLATFORM_SIMULATION</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_module</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulates the agent&#39;s platform including all components and subsystems that comprise the agent.</span>
<span class="sd">        Can receive instructions via internal messages of type &#39;PlatformTaskMessage&#39;, &#39;SubsystemTaskMessage&#39;,</span>
<span class="sd">        or &#39;ComponentTaskMessage&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># TODO create list of subsystems based on component list given to the platform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">CommandAndDataHandlingSubsystem</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
            <span class="n">GuidanceAndNavigationSubsystem</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
            <span class="n">ElectricPowerSubsystem</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
            <span class="n">PayloadSubsystem</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
            <span class="n">CommsSubsystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">),</span>
            <span class="n">AttitudeDeterminationAndControlSubsystem</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="c1"># TODO include internal state routing that kills the platform sim and the agent if a platform-level failure is detected    </span>

<div class="viewcode-block" id="PlatformSim.internal_message_handler"><a class="viewcode-back" href="../engineering.html#engineering.PlatformSim.internal_message_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">internal_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InternalMessage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forwards any task to the command and data handling subsystem</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dst_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span>
            <span class="k">if</span> <span class="n">dst_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="c1"># this module is NOT the intended receiver for this message. Forwarding to rightful destination</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">PlatformTaskMessage</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">SubsystemTaskMessage</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ComponentTaskMessage</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received a tasks message. Forwarding to </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">SubsystemNames</span><span class="o">.</span><span class="n">CNDH</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> for handling.&#39;</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span> <span class="o">=</span> <span class="n">SubsystemNames</span><span class="o">.</span><span class="n">CNDH</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># this module is the intended receiver for this message. Handling message</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Internal messages with contents of type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported. Discarding message.&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">--------------------------------------------------------</span>
<span class="sd"> ____                                                                              </span>
<span class="sd">/\  _`\                   __                                __                     </span>
<span class="sd">\ \ \L\_\    ___      __ /\_\    ___      __     __   _ __ /\_\    ___      __     </span>
<span class="sd"> \ \  _\L  /&#39; _ `\  /&#39;_ `\/\ \ /&#39; _ `\  /&#39;__`\ /&#39;__`\/\`&#39;__\/\ \ /&#39; _ `\  /&#39;_ `\   </span>
<span class="sd">  \ \ \L\ \/\ \/\ \/\ \L\ \ \ \/\ \/\ \/\  __//\  __/\ \ \/ \ \ \/\ \/\ \/\ \L\ \  </span>
<span class="sd">   \ \____/\ \_\ \_\ \____ \ \_\ \_\ \_\ \____\ \____\\ \_\  \ \_\ \_\ \_\ \____ \ </span>
<span class="sd">    \/___/  \/_/\/_/\/___L\ \/_/\/_/\/_/\/____/\/____/ \/_/   \/_/\/_/\/_/\/___L\ \</span>
<span class="sd">                      /\____/                                               /\____/</span>
<span class="sd">                      \_/__/                                                \_/__/    </span>
<span class="sd"> /&#39;\_/`\            /\ \         /\_ \            </span>
<span class="sd">/\      \    ___    \_\ \  __  __\//\ \      __   </span>
<span class="sd">\ \ \__\ \  / __`\  /&#39;_` \/\ \/\ \ \ \ \   /&#39;__`\ </span>
<span class="sd"> \ \ \_/\ \/\ \L\ \/\ \L\ \ \ \_\ \ \_\ \_/\  __/ </span>
<span class="sd">  \ \_\\ \_\ \____/\ \___,_\ \____/ /\____\ \____\</span>
<span class="sd">   \/_/ \/_/\/___/  \/__,_ /\/___/  \/____/\/____/                                                                                                                                                    </span>
<span class="sd">--------------------------------------------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="EngineeringModule"><a class="viewcode-back" href="../engineering.html#engineering.EngineeringModule">[docs]</a><span class="k">class</span> <span class="nc">EngineeringModule</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_agent</span> <span class="p">:</span> <span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">AgentModuleTypes</span><span class="o">.</span><span class="n">ENGINEERING_MODULE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">parent_agent</span><span class="p">,</span> <span class="p">[],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submodules</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">PlatformSim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="p">]</span>

<div class="viewcode-block" id="EngineeringModule.internal_message_handler"><a class="viewcode-back" href="../engineering.html#engineering.EngineeringModule.internal_message_handler">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">internal_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">InternalMessage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forwards any task to the platform simulator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dst_name</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span>
            <span class="k">if</span> <span class="n">dst_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="c1"># this module is NOT the intended receiver for this message. Forwarding to rightful destination</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">PlatformTaskMessage</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">SubsystemTaskMessage</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ComponentTaskMessage</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received a tasks message. Forwarding to </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">EngineeringModuleParts</span><span class="o">.</span><span class="n">PLATFORM_SIMULATION</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> for handling.&#39;</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">dst_module</span> <span class="o">=</span> <span class="n">EngineeringModuleParts</span><span class="o">.</span><span class="n">PLATFORM_SIMULATION</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_internal_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># this module is the intended receiver for this message. Handling message</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Internal messages with contents of type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s1"> not yet supported. Discarding message.&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">return</span></div></div>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">--------------------</span>
<span class="sd">DEBUGGING MAIN</span>
<span class="sd">--------------------    </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># if __name__ == &#39;__main__&#39;:</span>
<span class="c1">#     # print(&#39;Initializing agent...&#39;)</span>
<span class="c1">#     class PlanningModule(Module):</span>
<span class="c1">#         def __init__(self, parent_module : Module) -&gt; None:</span>
<span class="c1">#             super().__init__(AgentModuleTypes.PLANNING_MODULE.value, parent_module)</span>

<span class="c1">#         # async def coroutines(self):</span>
<span class="c1">#         #     &quot;&quot;&quot;</span>
<span class="c1">#         #     Routinely sends out a measurement task to the agent to perform every minute</span>
<span class="c1">#         #     &quot;&quot;&quot;</span>
<span class="c1">#         #     try:</span>
<span class="c1">#         #         while True:</span>
<span class="c1">#         #             task = ObservationTask(0, 0, [InstrumentNames.TEST.value], [1])</span>
<span class="c1">#         #             msg = PlatformTaskMessage(self.name, AgentModuleTypes.ENGINEERING_MODULE.value, task)</span>
<span class="c1">#         #             await self.send_internal_message(msg)</span>

<span class="c1">#         #             await self.sim_wait(100)</span>
<span class="c1">#         #     except asyncio.CancelledError:</span>
<span class="c1">#         #         return</span>

<span class="c1">#     class ScienceModule(Module):</span>
<span class="c1">#         def __init__(self, parent_module : Module) -&gt; None:</span>
<span class="c1">#             super().__init__(AgentModuleTypes.SCIENCE_MODULE.value, parent_module)</span>

<span class="c1">#     class TestAgent(AgentClient):    </span>
<span class="c1">#         def __init__(self, name, scenario_dir) -&gt; None:</span>
<span class="c1">#             super().__init__(name, scenario_dir)</span>
<span class="c1">#             self.submodules = [</span>
<span class="c1">#                 EngineeringModule(self),</span>
<span class="c1">#                 ScienceModule(self),</span>
<span class="c1">#                 PlanningModule(self)</span>
<span class="c1">#                 ]  </span>

<span class="c1">#     print(&#39;Initializing agent...&#39;)</span>
    
<span class="c1">#     agent = TestAgent(&#39;Mars1&#39;, &#39;./scenarios/sim_test&#39;)</span>
    
<span class="c1">#     asyncio.run(agent.live())</span>
    
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">3D-CHESS</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">dmas</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Alan Aguilar Jaramillo, Ben Gorr.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.2.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>